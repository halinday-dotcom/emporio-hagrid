<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emporio de Hagrid - Pedidos v2.2</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; }

        /* ===== PANTALLA DE LOGIN ===== */
        #pantallaLogin {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .login-box {
            background: white; border-radius: 20px; padding: 40px 35px;
            width: 90%; max-width: 380px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        .login-icono { font-size: 60px; margin-bottom: 10px; }
        .login-titulo { font-size: 24px; font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .login-subtitulo { font-size: 14px; color: #6b7280; margin-bottom: 30px; }
        .login-input {
            width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 10px;
            font-size: 18px; text-align: center; letter-spacing: 4px; margin-bottom: 15px;
            outline: none; transition: border-color 0.2s;
        }
        .login-input:focus { border-color: #2c3e50; }
        .login-btn {
            width: 100%; padding: 14px; background: #2c3e50; color: white;
            border: none; border-radius: 10px; font-size: 16px; font-weight: bold;
            cursor: pointer; transition: background 0.2s;
        }
        .login-btn:hover { background: #34495e; }
        .login-error {
            color: #ef4444; font-size: 13px; margin-top: 10px;
            display: none; font-weight: 600;
        }
        .login-error.visible { display: block; }
        .header { background: #2c3e50; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-bottom: 3px solid #34495e; }
        .header h1 { color: #ecf0f1; font-size: 24px; margin-bottom: 5px; }
        .header p { color: #bdc3c7; font-size: 14px; }
        .container { padding: 20px; }
        .btn-nuevo { background: #34495e; color: white; border: none; padding: 15px 25px; border-radius: 10px; font-size: 16px; font-weight: bold; width: 100%; margin-bottom: 20px; cursor: pointer; box-shadow: 0 4px 15px rgba(52,73,94,0.3); }
        .btn-nuevo:active { transform: scale(0.98); }
        .filtros { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; }
        .filtro-btn { background: white; border: 2px solid #e5e7eb; padding: 10px 20px; border-radius: 20px; font-size: 14px; white-space: nowrap; cursor: pointer; }
        .filtro-btn.activo { background: #34495e; color: white; border-color: #34495e; }
        .card { background: white; border-radius: 15px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card-imagen { width: 100%; height: 200px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 60px; }
        .card-imagen img { width: 100%; height: 100%; object-fit: cover; }
        .card-contenido { padding: 15px; }
        .card-titulo { font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 10px; }
        .card-info { font-size: 14px; color: #6b7280; margin-bottom: 5px; }
        .estado-badge { display: inline-block; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; margin-bottom: 10px; }
        .estado-recibido { background: #dbeafe; color: #1e40af; }
        .estado-fabricacion { background: #fef3c7; color: #92400e; }
        .estado-revision { background: #fed7aa; color: #9a3412; }
        .estado-listo { background: #d1fae5; color: #065f46; }
        .estado-entregado { background: #e5e7eb; color: #374151; }
        .card-acciones { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-ver { background: #34495e; color: white; }
        .btn-eliminar { background: #c0392b; color: white; flex: 0 0 50px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal.activo { display: block; }
        .modal-contenido { background: white; margin: 20px; border-radius: 15px; padding: 20px; max-width: 600px; margin: 20px auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-titulo { font-size: 22px; font-weight: bold; color: #1f2937; }
        .btn-cerrar { background: none; border: none; font-size: 30px; color: #6b7280; cursor: pointer; padding: 0; width: 40px; height: 40px; }
        .form-grupo { margin-bottom: 15px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 5px; }
        .form-input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; }
        .form-input:focus { outline: none; border-color: #9333ea; }
        textarea.form-input { resize: vertical; min-height: 80px; }
        .seccion-titulo { font-size: 16px; font-weight: bold; color: #2c3e50; margin: 20px 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb; }
        .upload-area { border: 2px dashed #d1d5db; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; background: #f9fafb; }
        .imagenes-preview { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .imagen-preview { position: relative; padding-top: 100%; border-radius: 8px; overflow: hidden; }
        .imagen-preview img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .imagen-preview-eliminar { position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 16px; cursor: pointer; z-index: 10; }
        .form-botones { display: flex; gap: 10px; margin-top: 25px; }
        .btn-cancelar { background: #f3f4f6; color: #374151; }
        .btn-guardar { background: #27ae60; color: white; }
        .timeline { margin-top: 20px; }
        .timeline-item { display: flex; margin-bottom: 20px; }
        .timeline-punto { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; margin-right: 15px; }
        .timeline-punto.completado { background: #10b981; color: white; }
        .timeline-punto.pendiente { background: #e5e7eb; color: #9ca3af; }
        .timeline-linea { width: 2px; background: #e5e7eb; margin-left: 19px; margin-top: -20px; margin-bottom: 0px; height: 20px; }
        .timeline-linea.completado { background: #10b981; }
        .timeline-contenido { flex: 1; }
        .timeline-etapa { font-weight: 600; margin-bottom: 5px; }
        .timeline-etapa.completado { color: #059669; }
        .timeline-etapa.pendiente { color: #9ca3af; }
        .timeline-fecha { font-size: 12px; color: #6b7280; }
        .vacio { text-align: center; padding: 60px 20px; color: #6b7280; }
        .vacio-icono { font-size: 60px; margin-bottom: 15px; }
        select.form-input { cursor: pointer; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-imprimir { background: #10b981; color: white; }
        @media print {
            body { background: white; }
            .header, .container, .modal { display: none; }
            .pagina-impresion { display: block !important; }
            .no-imprimir { display: none !important; }
        }
        .pagina-impresion { display: none; padding: 40px; background: white; }
        .impresion-header { text-align: center; border-bottom: 3px solid #9333ea; padding-bottom: 20px; margin-bottom: 30px; }
        .impresion-header h1 { color: #7c3aed; font-size: 32px; margin-bottom: 5px; }
        .impresion-seccion { margin-bottom: 30px; page-break-inside: avoid; }
        .impresion-seccion h3 { background: #f3f4f6; padding: 10px 15px; border-left: 4px solid #9333ea; margin-bottom: 15px; font-size: 18px; }
        .impresion-tabla { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .impresion-tabla td { padding: 10px; border-bottom: 1px solid #e5e7eb; }
        .impresion-tabla td:first-child { font-weight: bold; width: 180px; color: #374151; }
        .impresion-imagenes { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .impresion-imagen { text-align: center; page-break-inside: avoid; }
        .impresion-imagen img { width: 100%; max-height: 300px; object-fit: contain; border: 2px solid #e5e7eb; border-radius: 8px; }
        .impresion-imagen p { margin-top: 8px; font-size: 14px; color: #6b7280; }
        .impresion-timeline { margin-top: 20px; }
        .impresion-timeline-item { display: flex; align-items: center; padding: 12px; margin-bottom: 8px; background: #f9fafb; border-radius: 8px; }
        .impresion-timeline-check { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; }
        .impresion-timeline-check.completado { background: #10b981; color: white; }
        .impresion-timeline-check.pendiente { background: #e5e7eb; color: #9ca3af; }
        .impresion-pie { margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px; }
        .tabla-figuras { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .tabla-figuras th { background: #f3f4f6; padding: 10px; text-align: left; font-weight: 600; border: 1px solid #e5e7eb; }
        .tabla-figuras td { padding: 8px; border: 1px solid #e5e7eb; }
        .tabla-figuras input, .tabla-figuras select { width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; }
        .btn-agregar-figura { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-eliminar-fila { background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .resumen-total { background: #f9fafb; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .resumen-linea { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
        .resumen-linea:last-child { border-bottom: none; font-size: 18px; font-weight: bold; color: #2c3e50; padding-top: 12px; }
        .input-pequeno { width: 80px !important; }
        .col-figura { width: 30%; } .col-tamano { width: 15%; } .col-material { width: 15%; } .col-cantidad { width: 10%; } .col-valor { width: 12%; } .col-total { width: 12%; } .col-accion { width: 6%; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #34495e; }
        .stat-card.pendientes { border-left-color: #f59e0b; }
        .stat-card.completados { border-left-color: #10b981; }
        .stat-card.clientes { border-left-color: #3b82f6; }
        .stat-numero { font-size: 36px; font-weight: bold; color: #1f2937; margin: 10px 0; }
        .stat-label { color: #6b7280; font-size: 14px; }
        .stat-icono { font-size: 24px; margin-bottom: 5px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 0; overflow-x: auto; }
        .tab { background: none; border: none; padding: 12px 20px; font-size: 16px; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab.activo { color: #34495e; border-bottom-color: #34495e; }
        .btn-link { background: #3b82f6; color: white; }
        .check-fabricada { width: 20px; height: 20px; cursor: pointer; margin-right: 8px; accent-color: #10b981; }
        .figura-fabricada { text-decoration: line-through; opacity: 0.6; color: #10b981; }
        .figura-item { display: flex; align-items: flex-start; padding: 12px; background: white; border-radius: 10px; margin-bottom: 10px; border: 2px solid #f3f4f6; transition: all 0.2s; flex-direction: column; }
        .figura-item-header { display: flex; align-items: center; width: 100%; margin-bottom: 8px; }
        .figura-item:hover { border-color: #e5e7eb; }
        .figura-item.completada { background: #f0fdf4; border-color: #86efac; }
        .figura-info { flex: 1; }
        .progreso-figuras { background: #f3f4f6; padding: 12px 15px; border-radius: 8px; margin: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .progreso-barra { flex: 1; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin: 0 15px; }
        .progreso-relleno { height: 100%; background: linear-gradient(90deg, #10b981, #059669); transition: width 0.3s ease; }
        .badge-progreso { background: #10b981; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .cliente-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #9333ea; cursor: pointer; transition: all 0.2s; }
        .cliente-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateX(5px); }
        .cliente-nombre { font-weight: bold; font-size: 16px; color: #1f2937; margin-bottom: 5px; }
        .cliente-info { font-size: 13px; color: #6b7280; margin-bottom: 3px; }
        .badge-pedidos { display: inline-block; background: #34495e; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-top: 5px; }
        .indicador-nube { position: fixed; top: 70px; right: 20px; background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 12px; font-weight: 600; z-index: 100; display: flex; align-items: center; gap: 8px; }
        .indicador-nube.conectado { border-left: 4px solid #10b981; color: #10b981; }
        .indicador-nube.desconectado { border-left: 4px solid #f59e0b; color: #f59e0b; }
        .btn-sincronizar { background: #10b981; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-left: 10px; }
        .buscador { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .buscador-input { width: 100%; padding: 12px 15px 12px 45px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; transition: all 0.3s; }
        .buscador-input:focus { outline: none; border-color: #34495e; box-shadow: 0 0 0 3px rgba(52,73,94,0.1); }
        .buscador-contenedor { position: relative; }
        .buscador-icono { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 20px; color: #9ca3af; }
        .btn-limpiar-busqueda { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; display: none; }
        .btn-limpiar-busqueda.visible { display: block; }
        .resultados-busqueda { margin-top: 10px; font-size: 14px; color: #6b7280; font-weight: 600; }
        .highlight { background: #fef3c7; padding: 2px 4px; border-radius: 3px; font-weight: 600; }
        .link-seguimiento { background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px dashed #d1d5db; }
        .link-seguimiento input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; font-size: 12px; margin: 10px 0; }

        /* ===== HITOS DE PRODUCCI√ìN ===== */
        .hitos-figura-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px;
            margin-top: 8px;
            width: 100%;
        }
        .hitos-titulo-fig {
            font-size: 12px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        .hitos-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        .hito-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
        }
        .hito-btn:hover { border-color: #cbd5e1; background: #f8fafc; }
        .hito-btn.completado {
            border-color: #10b981;
            background: #ecfdf5;
            color: #065f46;
        }
        .hito-btn.completado .hito-icono { filter: none; }
        .hito-icono { font-size: 16px; }
        .hito-check {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #cbd5e1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            flex-shrink: 0;
            font-size: 11px;
            transition: all 0.2s;
        }
        .hito-btn.completado .hito-check {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }
        .barra-hitos-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }
        .barra-hitos {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        .barra-hitos-relleno {
            height: 100%;
            border-radius: 4px;
            transition: width 0.4s ease;
        }
        .barra-hitos-relleno.p0   { width: 0%;   background: #e2e8f0; }
        .barra-hitos-relleno.p25  { width: 25%;  background: #f59e0b; }
        .barra-hitos-relleno.p50  { width: 50%;  background: #f59e0b; }
        .barra-hitos-relleno.p75  { width: 75%;  background: #3b82f6; }
        .barra-hitos-relleno.p100 { width: 100%; background: #10b981; }
        .barra-hitos-pct {
            font-size: 12px;
            font-weight: 700;
            min-width: 36px;
            text-align: right;
        }
        .barra-hitos-pct.p0   { color: #94a3b8; }
        .barra-hitos-pct.p25  { color: #f59e0b; }
        .barra-hitos-pct.p50  { color: #f59e0b; }
        .barra-hitos-pct.p75  { color: #3b82f6; }
        .barra-hitos-pct.p100 { color: #10b981; }
    </style>
</head>
<body>

    <!-- PANTALLA DE LOGIN -->
    <div id="pantallaLogin">
        <div class="login-box">
            <div class="login-icono">üßô‚Äç‚ôÇÔ∏è</div>
            <div class="login-titulo">Emporio de Hagrid</div>
            <div class="login-subtitulo">Ingresa la contrase√±a para continuar</div>
            <input type="password" class="login-input" id="inputPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter') verificarPassword()">
            <button class="login-btn" onclick="verificarPassword()">Entrar</button>
            <div class="login-error" id="loginError">‚ùå Contrase√±a incorrecta</div>
        </div>
    </div>

    <div class="header">
        <h1>üßô‚Äç‚ôÇÔ∏è Emporio de Hagrid</h1>
        <p>Gesti√≥n de Pedidos</p>
    </div>
    
    <div class="indicador-nube conectado" id="indicadorNube">
        <span>‚òÅÔ∏è</span>
        <span id="textoIndicador">Conectado a Google Sheets</span>
        <button class="btn-sincronizar" onclick="sincronizarManual()">üîÑ Sincronizar</button>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab activo" onclick="cambiarTab('pedidos')">üì¶ Pedidos</button>
            <button class="tab" onclick="cambiarTab('clientes')">üë• Clientes</button>
            <button class="tab" onclick="cambiarTab('dashboard')">üìä Dashboard</button>
        </div>
        
        <div id="vistaPedidos">
            <button class="btn-nuevo" onclick="mostrarFormulario()">+ Nuevo Pedido</button>
            <div class="buscador">
                <div class="buscador-contenedor">
                    <span class="buscador-icono">üîç</span>
                    <input type="text" class="buscador-input" id="inputBusqueda" placeholder="Buscar por nombre, Instagram, celular, pedido #, figura..." oninput="buscarPedidos(this.value)">
                    <button class="btn-limpiar-busqueda" id="btnLimpiarBusqueda" onclick="limpiarBusqueda()">‚úï Limpiar</button>
                </div>
                <div class="resultados-busqueda" id="resultadosBusqueda"></div>
            </div>
            <div class="filtros" id="filtros">
                <button class="filtro-btn activo" onclick="filtrarPedidos('todos')">üì¶ Todos</button>
                <button class="filtro-btn" onclick="filtrarPedidos('recibido')">üì• Recibidos</button>
                <button class="filtro-btn" onclick="filtrarPedidos('fabricacion')">üî® Fabricaci√≥n</button>
                <button class="filtro-btn" onclick="filtrarPedidos('revision')">üîç Revisi√≥n</button>
                <button class="filtro-btn" onclick="filtrarPedidos('listo')">‚úÖ Listos</button>
                <button class="filtro-btn" onclick="filtrarPedidos('entregado')">üì¶ Entregados</button>
            </div>
            <div id="listaPedidos"></div>
        </div>
        
        <div id="vistaClientes" style="display: none;">
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h2 style="color: #7c3aed; margin-bottom: 10px;">üë• Historial de Clientes</h2>
                <p style="color: #6b7280;">Haz clic en un cliente para ver su historial completo</p>
            </div>
            <div id="listaClientes"></div>
        </div>
        
        <div id="vistaDashboard" style="display: none;">
            <h2 style="color: #7c3aed; margin-bottom: 20px; font-size: 24px;">üìä Dashboard de Ventas</h2>
            <div class="dashboard" id="dashboardStats"></div>
            <div id="graficoPedidos"></div>
        </div>
    </div>

    <!-- Modal Formulario -->
    <div class="modal" id="modalFormulario">
        <div class="modal-contenido">
            <div class="modal-header">
                <h2 class="modal-titulo">Nuevo Pedido</h2>
                <button class="btn-cerrar" onclick="cerrarFormulario()">√ó</button>
            </div>
            <form id="formPedido" onsubmit="guardarPedido(event)">
                <div class="seccion-titulo">Datos del Cliente</div>
                <div class="grid-2">
                    <div class="form-grupo"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="nombre" required></div>
                    <div class="form-grupo"><label class="form-label">Apellido *</label><input type="text" class="form-input" id="apellido" required></div>
                </div>
                <div class="grid-2">
                    <div class="form-grupo"><label class="form-label">Celular *</label><input type="tel" class="form-input" id="celular" required placeholder="+56 9 1234 5678"></div>
                    <div class="form-grupo"><label class="form-label">Instagram</label><input type="text" class="form-input" id="instagram" placeholder="@usuario"></div>
                </div>
                <div class="form-grupo"><label class="form-label">Correo Electr√≥nico</label><input type="email" class="form-input" id="email" placeholder="ejemplo@correo.com"></div>
                <div class="form-grupo"><label class="form-label">Direcci√≥n de Entrega *</label><input type="text" class="form-input" id="direccion" required placeholder="Calle y n√∫mero"></div>
                <div class="grid-2">
                    <div class="form-grupo">
                        <label class="form-label">Comuna *</label>
                        <select class="form-input" id="comuna" required>
                            <option value="">Seleccionar comuna...</option>
                            <optgroup label="Santiago">
                                <option>Cerrillos</option><option>Cerro Navia</option><option>Conchal√≠</option><option>El Bosque</option><option>Estaci√≥n Central</option><option>Huechuraba</option><option>Independencia</option><option>La Cisterna</option><option>La Florida</option><option>La Granja</option><option>La Pintana</option><option>La Reina</option><option>Las Condes</option><option>Lo Barnechea</option><option>Lo Espejo</option><option>Lo Prado</option><option>Macul</option><option>Maip√∫</option><option>√ëu√±oa</option><option>Pedro Aguirre Cerda</option><option>Pe√±alol√©n</option><option>Providencia</option><option>Pudahuel</option><option>Quilicura</option><option>Quinta Normal</option><option>Recoleta</option><option>Renca</option><option>San Joaqu√≠n</option><option>San Miguel</option><option>San Ram√≥n</option><option>Santiago Centro</option><option>Vitacura</option>
                            </optgroup>
                            <optgroup label="Regiones">
                                <option>Arica</option><option>Iquique</option><option>Antofagasta</option><option>Calama</option><option>Copiap√≥</option><option>La Serena</option><option>Coquimbo</option><option>Valpara√≠so</option><option>Vi√±a del Mar</option><option>Rancagua</option><option>Talca</option><option>Concepci√≥n</option><option>Temuco</option><option>Valdivia</option><option>Osorno</option><option>Puerto Montt</option><option>Punta Arenas</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-grupo">
                        <label class="form-label">Ubicaci√≥n *</label>
                        <select class="form-input" id="ubicacion" required>
                            <option value="">Seleccionar...</option>
                            <option>Santiago</option><option>Regi√≥n</option>
                        </select>
                    </div>
                </div>
                <div class="form-grupo">
                    <label class="form-label">Estado de Pago *</label>
                    <select class="form-input" id="estadoPago" required>
                        <option value="">Seleccionar...</option>
                        <option>Pagado</option><option>Por Pagar</option>
                    </select>
                </div>
                <div class="seccion-titulo">Cotizaci√≥n de Figuras</div>
                <div style="overflow-x: auto;">
                    <table class="tabla-figuras" id="tablaFiguras">
                        <thead><tr>
                            <th class="col-figura">Figura</th><th class="col-tamano">Tama√±o</th><th class="col-material">Material</th><th class="col-cantidad">Cant.</th><th class="col-valor">Valor Unit.</th><th class="col-total">Total</th><th class="col-accion"></th>
                        </tr></thead>
                        <tbody id="cuerpoTablaFiguras"></tbody>
                    </table>
                </div>
                <button type="button" class="btn-agregar-figura" onclick="agregarFilaFigura()">+ Agregar Figura</button>
                <div class="resumen-total" id="resumenTotal">
                    <div class="resumen-linea"><span>Subtotal:</span><span id="subtotalTexto">$0</span></div>
                    <div class="resumen-linea">
                        <span>Descuento:</span>
                        <div><input type="number" id="descuentoPorcentaje" value="0" min="0" max="100" style="width: 60px; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px;" oninput="calcularTotales()"> % <span id="descuentoTexto" style="margin-left: 10px;">$0</span></div>
                    </div>
                    <div class="resumen-linea"><span>TOTAL:</span><span id="totalFinalTexto">$0</span></div>
                </div>
                <div class="form-grupo" style="margin-top: 20px;"><label class="form-label">Observaciones</label><textarea class="form-input" id="observaciones" placeholder="Notas sobre el pedido..."></textarea></div>
                <div class="seccion-titulo">Im√°genes</div>
                <div class="upload-area" onclick="document.getElementById('inputImagenes').click()">
                    <div style="font-size: 40px; margin-bottom: 10px;">üì∑</div>
                    <div style="color: #6b7280;">Toca para subir im√°genes</div>
                </div>
                <input type="file" id="inputImagenes" accept="image/*" multiple style="display: none;" onchange="procesarImagenes(event)">
                <div id="imagenesPreview" class="imagenes-preview"></div>
                <div class="form-botones">
                    <button type="button" class="btn btn-cancelar" onclick="cerrarFormulario()">Cancelar</button>
                    <button type="submit" class="btn btn-guardar">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalle -->
    <div class="modal" id="modalDetalle">
        <div class="modal-contenido">
            <div class="modal-header">
                <h2 class="modal-titulo" id="detalleTitulo"></h2>
                <button class="btn-cerrar" onclick="cerrarDetalle()">√ó</button>
            </div>
            <div id="detalleContenido"></div>
            <div class="link-seguimiento">
                <strong style="color: #7c3aed;">üîó Link de Seguimiento para el Cliente</strong>
                <p style="font-size: 13px; color: #6b7280; margin: 5px 0;">Comparte este link con tu cliente</p>
                <input type="text" id="linkSeguimiento" readonly onclick="this.select()">
                <button class="btn btn-link" style="width: 100%; margin-top: 5px;" onclick="copiarLinkSeguimiento()">üìã Copiar Link</button>
            </div>
            <div class="form-botones">
                <button class="btn btn-imprimir" onclick="imprimirPedido()">üñ®Ô∏è Imprimir</button>
                <button class="btn btn-imprimir" onclick="imprimirEtiquetaEnvio()" style="background: #3498db;">üì¶ Etiqueta</button>
                <button class="btn btn-ver" onclick="cerrarDetalle()">Volver</button>
            </div>
        </div>
    </div>

    <div class="pagina-impresion" id="paginaImpresion"></div>

    <div class="modal" id="paginaSeguimiento" style="background: white;">
        <div class="modal-contenido" style="max-width: 800px;">
            <div style="background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%); color: white; padding: 30px; border-radius: 15px 15px 0 0; margin: -20px -20px 20px -20px;">
                <h1 style="margin: 0; font-size: 28px;">üßô‚Äç‚ôÇÔ∏è Emporio de Hagrid</h1>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">Seguimiento de Pedido</p>
            </div>
            <div id="contenidoSeguimiento"></div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx4G2esPGqgPdzMrgFCxBQb_i6EY78RB6ebIN4CLnKDYWr5KbQvuLeCMZ_kw4ESevfI/exec';

        // ===== CONTRASE√ëA =====
        const PASSWORD = 'hagrid2024';

        function verificarPassword() {
            const input = document.getElementById('inputPassword').value;
            const error = document.getElementById('loginError');
            if (input === PASSWORD) {
                sessionStorage.setItem('hagridAuth', 'ok');
                document.getElementById('pantallaLogin').style.display = 'none';
            } else {
                error.classList.add('visible');
                document.getElementById('inputPassword').value = '';
                document.getElementById('inputPassword').focus();
                setTimeout(() => error.classList.remove('visible'), 3000);
            }
        }

        // Verificar si ya est√° autenticado
        if (sessionStorage.getItem('hagridAuth') === 'ok') {
            document.getElementById('pantallaLogin').style.display = 'none';
        }
        // ===== FIN CONTRASE√ëA =====
        let pedidos = [], imagenesTemp = [], filtroActual = 'todos', pedidoActual = null;
        let contadorFilas = 0, tabActual = 'pedidos', terminoBusqueda = '', pedidosFiltrados = [];
        let modoEdicion = false, pedidoEnEdicion = null;

        const HITOS_DEF = [
            { key: 'fabricado',  label: 'Fabricado',  icono: 'üî®' },
            { key: 'limpiado',   label: 'Limpiado',   icono: 'üßπ' },
            { key: 'curado',     label: 'Curado',     icono: '‚öóÔ∏è'  },
            { key: 'imprimado',  label: 'Imprimado',  icono: 'üé®' }
        ];

        window.onload = function() {
            mostrarCargando();
            cargarPedidosDesdeNube();
            verificarSeguimiento();
        };

        function verificarSeguimiento() {
            const urlParams = new URLSearchParams(window.location.search);
            const pedidoId = urlParams.get('pedido');
            if (pedidoId) mostrarSeguimientoPublico(parseInt(pedidoId));
        }

        // ============ HITOS ============
        function initHitos(figura) {
            if (!figura.hitos) {
                figura.hitos = { fabricado: false, limpiado: false, curado: false, imprimado: false };
            }
            return figura.hitos;
        }

        function calcularPctHitos(hitos) {
            if (!hitos) return 0;
            const completados = HITOS_DEF.filter(h => hitos[h.key]).length;
            return Math.round((completados / HITOS_DEF.length) * 100);
        }

        function claseBarraHitos(pct) {
            if (pct === 0)   return 'p0';
            if (pct <= 25)   return 'p25';
            if (pct <= 50)   return 'p50';
            if (pct <= 75)   return 'p75';
            return 'p100';
        }

        function renderHitosFigura(pedidoId, figIdx, figura) {
            const hitos = initHitos(figura);
            const pct = calcularPctHitos(hitos);
            const cls = claseBarraHitos(pct);

            const btns = HITOS_DEF.map(h => {
                const done = hitos[h.key];
                return `<button class="hito-btn ${done ? 'completado' : ''}" onclick="toggleHito(${pedidoId}, ${figIdx}, '${h.key}')">
                    <span class="hito-icono">${h.icono}</span>
                    <span>${h.label}</span>
                    <span class="hito-check">${done ? '‚úì' : ''}</span>
                </button>`;
            }).join('');

            return `
                <div class="hitos-figura-container">
                    <div class="hitos-titulo-fig">‚öôÔ∏è Proceso de fabricaci√≥n</div>
                    <div class="hitos-grid">${btns}</div>
                    <div class="barra-hitos-container">
                        <div class="barra-hitos">
                            <div class="barra-hitos-relleno ${cls}"></div>
                        </div>
                        <span class="barra-hitos-pct ${cls}">${pct}%</span>
                    </div>
                </div>`;
        }

        function toggleHito(pedidoId, figIdx, hitoKey) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (!pedido || !pedido.figuras || !pedido.figuras[figIdx]) return;
            const fig = pedido.figuras[figIdx];
            initHitos(fig);
            fig.hitos[hitoKey] = !fig.hitos[hitoKey];
            actualizarPedidoEnNube(pedido);
            verDetalle(pedidoId);
        }
        // ============ FIN HITOS ============

        function buscarPedidos(termino) {
            terminoBusqueda = termino.toLowerCase().trim();
            const btnLimpiar = document.getElementById('btnLimpiarBusqueda');
            const resultadosDiv = document.getElementById('resultadosBusqueda');
            if (terminoBusqueda) { btnLimpiar.classList.add('visible'); } 
            else { btnLimpiar.classList.remove('visible'); resultadosDiv.textContent = ''; renderizarPedidos(); return; }
            pedidosFiltrados = pedidos.filter(p => {
                if (p.id.toString().includes(terminoBusqueda)) return true;
                if (`${p.nombre||''} ${p.apellido||''}`.toLowerCase().includes(terminoBusqueda)) return true;
                if (p.celular && p.celular.toLowerCase().includes(terminoBusqueda)) return true;
                if (p.comuna && p.comuna.toLowerCase().includes(terminoBusqueda)) return true;
                if (p.figuras && p.figuras.some(f => f.nombre && f.nombre.toLowerCase().includes(terminoBusqueda))) return true;
                if (p.observaciones && p.observaciones.toLowerCase().includes(terminoBusqueda)) return true;
                return false;
            });
            if (filtroActual !== 'todos') pedidosFiltrados = pedidosFiltrados.filter(p => p.estado === filtroActual);
            const total = pedidosFiltrados.length;
            resultadosDiv.innerHTML = total === 0 ? '‚ùå Sin resultados para "<span class="highlight">' + termino + '</span>"' : '‚úì ' + total + ' pedido(s) encontrado(s)';
            renderizarPedidos();
        }

        function limpiarBusqueda() {
            terminoBusqueda = ''; pedidosFiltrados = [];
            document.getElementById('inputBusqueda').value = '';
            document.getElementById('btnLimpiarBusqueda').classList.remove('visible');
            document.getElementById('resultadosBusqueda').textContent = '';
            renderizarPedidos();
        }

        function resaltarTexto(texto, termino) {
            if (!termino || !texto) return texto;
            return texto.replace(new RegExp(`(${termino})`, 'gi'), '<span class="highlight">$1</span>');
        }

        function cambiarTab(tab) {
            tabActual = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('activo'));
            event.target.classList.add('activo');
            document.getElementById('vistaPedidos').style.display = 'none';
            document.getElementById('vistaClientes').style.display = 'none';
            document.getElementById('vistaDashboard').style.display = 'none';
            if (tab === 'pedidos') document.getElementById('vistaPedidos').style.display = 'block';
            else if (tab === 'clientes') { document.getElementById('vistaClientes').style.display = 'block'; renderizarClientes(); }
            else if (tab === 'dashboard') { document.getElementById('vistaDashboard').style.display = 'block'; renderizarDashboard(); }
        }

        function renderizarClientes() {
            const clientesMap = new Map();
            pedidos.forEach(p => {
                const cel = p.celular || 'N/A';
                if (!clientesMap.has(cel)) clientesMap.set(cel, { nombre: p.nombreCompleto || `${p.nombre} ${p.apellido}`, celular: cel, email: p.email || 'N/A', comuna: p.comuna || 'N/A', pedidos: [] });
                clientesMap.get(cel).pedidos.push(p);
            });
            const lista = document.getElementById('listaClientes');
            if (!clientesMap.size) { lista.innerHTML = '<div class="card"><div class="vacio"><div class="vacio-icono">üë•</div><p>No hay clientes</p></div></div>'; return; }
            lista.innerHTML = '';
            Array.from(clientesMap.values()).sort((a,b) => b.pedidos.length - a.pedidos.length).forEach(c => {
                const total = c.pedidos.reduce((s,p) => s + (p.totalFinal||0), 0);
                const ul = c.pedidos[c.pedidos.length-1];
                const card = document.createElement('div'); card.className = 'cliente-card'; card.onclick = () => mostrarHistorialCliente(c);
                card.innerHTML = `<div class="cliente-nombre">${c.nombre}</div><div class="cliente-info">üì± ${c.celular}</div><div class="cliente-info">üìç ${c.comuna}</div><div class="cliente-info">üí∞ $${total.toLocaleString('es-CL')}</div><div class="cliente-info">üìÖ ${new Date(ul.fechaPedido).toLocaleDateString()}</div><span class="badge-pedidos">${c.pedidos.length} pedido(s)</span>`;
                lista.appendChild(card);
            });
        }

        function mostrarHistorialCliente(cliente) {
            const modal = document.getElementById('modalDetalle');
            document.getElementById('detalleTitulo').textContent = `Historial de ${cliente.nombre}`;
            document.getElementById('detalleContenido').innerHTML = `
                <div class="seccion-titulo">Informaci√≥n del Cliente</div>
                <div class="card-info"><strong>Nombre:</strong> ${cliente.nombre}</div>
                <div class="card-info"><strong>Celular:</strong> ${cliente.celular}</div>
                <div class="seccion-titulo">Pedidos (${cliente.pedidos.length})</div>
                ${cliente.pedidos.map(p => `<div class="card" style="margin-bottom:10px;"><div class="card-contenido"><strong>Pedido #${p.id}</strong> - $${(p.totalFinal||0).toLocaleString('es-CL')}<br><button class="btn btn-ver" style="width:100%;margin-top:8px;" onclick="verDetalle(${p.id})">Ver Detalle</button></div></div>`).join('')}`;
            document.querySelector('.link-seguimiento').style.display = 'none';
            modal.classList.add('activo');
        }

        function renderizarDashboard() {
            const total = pedidos.length, pendientes = pedidos.filter(p => p.estado !== 'entregado').length, completados = pedidos.filter(p => p.estado === 'entregado').length;
            const clientes = new Set(pedidos.map(p => p.celular).filter(Boolean)).size;
            const ingresos = pedidos.filter(p => p.estadoPago === 'Pagado').reduce((s,p) => s+(p.totalFinal||0), 0);
            const porCobrar = pedidos.filter(p => p.estadoPago === 'Por Pagar').reduce((s,p) => s+(p.totalFinal||0), 0);
            document.getElementById('dashboardStats').innerHTML = `
                <div class="stat-card"><div class="stat-icono">üì¶</div><div class="stat-label">Total Pedidos</div><div class="stat-numero">${total}</div></div>
                <div class="stat-card pendientes"><div class="stat-icono">‚è≥</div><div class="stat-label">Pendientes</div><div class="stat-numero">${pendientes}</div></div>
                <div class="stat-card completados"><div class="stat-icono">‚úÖ</div><div class="stat-label">Completados</div><div class="stat-numero">${completados}</div></div>
                <div class="stat-card clientes"><div class="stat-icono">üë•</div><div class="stat-label">Clientes</div><div class="stat-numero">${clientes}</div></div>
                <div class="stat-card" style="border-left-color:#10b981"><div class="stat-icono">üí∞</div><div class="stat-label">Ingresos (Pagados)</div><div class="stat-numero" style="font-size:24px">$${ingresos.toLocaleString('es-CL')}</div></div>
                <div class="stat-card" style="border-left-color:#f59e0b"><div class="stat-icono">‚è∞</div><div class="stat-label">Por Cobrar</div><div class="stat-numero" style="font-size:24px">$${porCobrar.toLocaleString('es-CL')}</div></div>`;
            const estados = ['recibido','fabricacion','revision','listo','entregado'];
            const nombres = {recibido:'Recibidos',fabricacion:'En Fabricaci√≥n',revision:'En Revisi√≥n',listo:'Listos',entregado:'Entregados'};
            const colores = {recibido:'#3b82f6',fabricacion:'#f59e0b',revision:'#f97316',listo:'#10b981',entregado:'#6b7280'};
            document.getElementById('graficoPedidos').innerHTML = `<div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1)"><h3 style="color:#7c3aed;margin-bottom:20px">Estado de Pedidos</h3>${estados.map(e => { const c = pedidos.filter(p=>p.estado===e).length; const pct = (c/(total||1))*100; return `<div style="margin-bottom:15px"><div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="font-weight:600">${nombres[e]}</span><span>${c}</span></div><div style="width:100%;height:12px;background:#f3f4f6;border-radius:6px;overflow:hidden"><div style="width:${pct}%;height:100%;background:${colores[e]}"></div></div></div>`; }).join('')}</div>`;
        }

        function generarLinkSeguimiento(id) { return `${window.location.origin}${window.location.pathname}?pedido=${id}`; }

        function copiarLinkSeguimiento() {
            document.getElementById('linkSeguimiento').select();
            document.execCommand('copy');
            const btn = event.target; btn.textContent = '‚úÖ ¬°Copiado!';
            setTimeout(() => btn.textContent = 'üìã Copiar Link', 2000);
        }

        function mostrarCargando() {
            document.getElementById('listaPedidos').innerHTML = '<div class="card"><div class="vacio"><div class="vacio-icono">‚è≥</div><p>Cargando pedidos...</p></div></div>';
        }

        function actualizarIndicadorNube(conectado, msg) {
            const ind = document.getElementById('indicadorNube');
            ind.className = 'indicador-nube ' + (conectado ? 'conectado' : 'desconectado');
            document.getElementById('textoIndicador').textContent = msg || (conectado ? 'Conectado a Google Sheets' : 'Sin conexi√≥n');
        }

        async function sincronizarManual() {
            actualizarIndicadorNube(true, 'Sincronizando...');
            await cargarPedidosDesdeNube();
            actualizarIndicadorNube(true, 'Sincronizado ‚úì');
            setTimeout(() => actualizarIndicadorNube(true), 2000);
        }

        async function cargarPedidosDesdeNube() {
            try {
                const r = await fetch(GOOGLE_SCRIPT_URL + '?action=obtenerPedidos');
                const d = await r.json();
                if (d.status === 'success') { pedidos = d.pedidos || []; actualizarIndicadorNube(true); }
                else { cargarPedidosLocal(); actualizarIndicadorNube(false, 'Error de conexi√≥n'); }
            } catch(e) { cargarPedidosLocal(); actualizarIndicadorNube(false, 'Sin conexi√≥n - Modo local'); }
            finally { renderizarPedidos(); }
        }

        function cargarPedidosLocal() {
            const g = localStorage.getItem('pedidosEmporioHagrid');
            if (g) pedidos = JSON.parse(g);
        }

        async function guardarPedidoEnNube(pedido) {
            try {
                localStorage.setItem('pedidosEmporioHagrid', JSON.stringify(pedidos));
                const fd = new FormData(); fd.append('action','guardarPedido'); fd.append('pedido', JSON.stringify(pedido));
                const r = await fetch(GOOGLE_SCRIPT_URL, {method:'POST', body:fd});
                const d = await r.json();
                if (d.status === 'success') { actualizarIndicadorNube(true, 'Guardado ‚úì'); setTimeout(() => actualizarIndicadorNube(true), 2000); return true; }
            } catch(e) { actualizarIndicadorNube(false, 'Sin conexi√≥n'); }
            return false;
        }

        async function actualizarPedidoEnNube(pedido) {
            try {
                localStorage.setItem('pedidosEmporioHagrid', JSON.stringify(pedidos));
                const fd = new FormData(); fd.append('action','actualizarPedido'); fd.append('pedido', JSON.stringify(pedido));
                const r = await fetch(GOOGLE_SCRIPT_URL, {method:'POST', body:fd});
                const d = await r.json();
                if (d.status === 'success') { actualizarIndicadorNube(true, 'Actualizado ‚úì'); setTimeout(() => actualizarIndicadorNube(true), 2000); return true; }
            } catch(e) {}
            return false;
        }

        async function eliminarPedidoEnNube(id) {
            try {
                localStorage.setItem('pedidosEmporioHagrid', JSON.stringify(pedidos));
                const fd = new FormData(); fd.append('action','eliminarPedido'); fd.append('pedidoId', id);
                const r = await fetch(GOOGLE_SCRIPT_URL, {method:'POST', body:fd});
                const d = await r.json();
                return d.status === 'success';
            } catch(e) { return false; }
        }

        function mostrarFormulario(pedidoId = null) {
            modoEdicion = false; pedidoEnEdicion = null;
            document.getElementById('modalFormulario').classList.add('activo');
            document.getElementById('formPedido').reset();
            imagenesTemp = []; contadorFilas = 0;
            document.getElementById('imagenesPreview').innerHTML = '';
            document.getElementById('cuerpoTablaFiguras').innerHTML = '';
            document.getElementById('descuentoPorcentaje').value = 0;
            if (pedidoId) {
                const p = pedidos.find(x => x.id === pedidoId);
                if (p) { modoEdicion = true; pedidoEnEdicion = p; cargarPedidoEnFormulario(p); document.querySelector('.modal-titulo').textContent = 'Editar Pedido #' + p.id; }
            } else { document.querySelector('.modal-titulo').textContent = 'Nuevo Pedido'; agregarFilaFigura(); }
            calcularTotales();
        }

        function cargarPedidoEnFormulario(p) {
            document.getElementById('nombre').value = p.nombre||'';
            document.getElementById('apellido').value = p.apellido||'';
            document.getElementById('celular').value = p.celular||'';
            document.getElementById('instagram').value = p.instagram||'';
            document.getElementById('email').value = p.email||'';
            document.getElementById('direccion').value = p.direccion||'';
            document.getElementById('comuna').value = p.comuna||'';
            document.getElementById('ubicacion').value = p.ubicacion||'';
            document.getElementById('estadoPago').value = p.estadoPago||'';
            document.getElementById('observaciones').value = p.observaciones||'';
            document.getElementById('descuentoPorcentaje').value = p.descuentoPorcentaje||0;
            if (p.imagenes && p.imagenes.length) { imagenesTemp = [...p.imagenes]; renderizarPreviewImagenes(); }
            if (p.figuras && p.figuras.length) {
                p.figuras.forEach(fig => {
                    agregarFilaFigura();
                    const fila = document.getElementById(`fila-${contadorFilas}`);
                    if (fila) {
                        fila.querySelectorAll('input, select').forEach(inp => {
                            const c = inp.dataset.campo;
                            if (c === 'nombre') inp.value = fig.nombre||'';
                            else if (c === 'tamano') { if (!['28mm','32mm'].includes(fig.tamano)) { inp.value = 'Personalizado'; mostrarCampoPersonalizado(contadorFilas,'tamano'); const ip = document.getElementById(`input-tamano-${contadorFilas}`); if(ip) ip.value = fig.tamanoFinal||fig.tamano||''; } else inp.value = fig.tamano; }
                            else if (c === 'material') { if (!['Resina','PLA'].includes(fig.material)) { inp.value = 'Otro'; mostrarCampoPersonalizado(contadorFilas,'material'); const im = document.getElementById(`input-material-${contadorFilas}`); if(im) im.value = fig.materialFinal||fig.material||''; } else inp.value = fig.material; }
                            else if (c === 'cantidad') inp.value = fig.cantidad||1;
                            else if (c === 'valorUnitario') inp.value = fig.valorUnitario||0;
                        });
                    }
                });
            } else { agregarFilaFigura(); }
            calcularTotales();
        }

        function cerrarFormulario() { document.getElementById('modalFormulario').classList.remove('activo'); }

        function procesarImagenes(event) {
            Array.from(event.target.files).forEach(f => {
                const r = new FileReader(); r.onload = e => { imagenesTemp.push(e.target.result); renderizarPreviewImagenes(); }; r.readAsDataURL(f);
            });
        }

        function renderizarPreviewImagenes() {
            document.getElementById('imagenesPreview').innerHTML = imagenesTemp.map((img,i) => `<div class="imagen-preview"><img src="${img}"><button type="button" class="imagen-preview-eliminar" onclick="eliminarImagenTemp(${i})">√ó</button></div>`).join('');
        }

        function eliminarImagenTemp(i) { imagenesTemp.splice(i,1); renderizarPreviewImagenes(); }

        function agregarFilaFigura() {
            contadorFilas++;
            const tbody = document.getElementById('cuerpoTablaFiguras');
            const tr = document.createElement('tr'); tr.id = `fila-${contadorFilas}`;
            tr.innerHTML = `
                <td><input type="text" class="form-input" placeholder="Nombre de la figura" data-fila="${contadorFilas}" data-campo="nombre"></td>
                <td>
                    <select class="form-input" data-fila="${contadorFilas}" data-campo="tamano" id="select-tamano-${contadorFilas}" onchange="mostrarCampoPersonalizado(${contadorFilas},'tamano')">
                        <option value="28mm">28mm</option><option value="32mm">32mm</option><option value="Personalizado">Personalizado</option>
                    </select>
                    <input type="text" class="form-input" placeholder="Especificar" style="display:none;margin-top:5px" data-fila="${contadorFilas}" data-campo="tamanoPersonalizado" id="input-tamano-${contadorFilas}">
                </td>
                <td>
                    <select class="form-input" data-fila="${contadorFilas}" data-campo="material" id="select-material-${contadorFilas}" onchange="mostrarCampoPersonalizado(${contadorFilas},'material')">
                        <option value="Resina">Resina</option><option value="PLA">PLA</option><option value="Otro">Otro</option>
                    </select>
                    <input type="text" class="form-input" placeholder="Especificar" style="display:none;margin-top:5px" data-fila="${contadorFilas}" data-campo="materialPersonalizado" id="input-material-${contadorFilas}">
                </td>
                <td><input type="number" class="form-input input-pequeno" value="1" min="1" data-fila="${contadorFilas}" data-campo="cantidad" onchange="calcularTotales()"></td>
                <td><input type="number" class="form-input input-pequeno" value="0" min="0" data-fila="${contadorFilas}" data-campo="valorUnitario" onchange="calcularTotales()"></td>
                <td><strong id="total-${contadorFilas}">$0</strong></td>
                <td style="text-align:center"><button type="button" class="btn-eliminar-fila" onclick="eliminarFilaFigura(${contadorFilas})">‚úï</button></td>`;
            tbody.appendChild(tr);
        }

        function mostrarCampoPersonalizado(id, tipo) {
            const sel = document.getElementById(`select-${tipo}-${id}`);
            const inp = document.getElementById(`input-${tipo}-${id}`);
            const val = tipo === 'tamano' ? 'Personalizado' : 'Otro';
            if (sel.value === val) { inp.style.display = 'block'; inp.focus(); } else { inp.style.display = 'none'; inp.value = ''; }
        }

        function eliminarFilaFigura(id) { const f = document.getElementById(`fila-${id}`); if(f) { f.remove(); calcularTotales(); } }

        function calcularTotales() {
            let sub = 0;
            Array.from(document.getElementById('cuerpoTablaFiguras').getElementsByTagName('tr')).forEach(fila => {
                let cant = 1, val = 0, id = null;
                fila.querySelectorAll('input,select').forEach(inp => {
                    id = inp.dataset.fila;
                    if (inp.dataset.campo === 'cantidad') cant = parseInt(inp.value)||1;
                    else if (inp.dataset.campo === 'valorUnitario') val = parseFloat(inp.value)||0;
                });
                const t = cant * val; sub += t;
                if (id) { const el = document.getElementById(`total-${id}`); if(el) el.textContent = `$${t.toLocaleString('es-CL')}`; }
            });
            const desc = parseFloat(document.getElementById('descuentoPorcentaje').value)||0;
            const d = (sub * desc) / 100;
            document.getElementById('subtotalTexto').textContent = `$${sub.toLocaleString('es-CL')}`;
            document.getElementById('descuentoTexto').textContent = `-$${d.toLocaleString('es-CL')}`;
            document.getElementById('totalFinalTexto').textContent = `$${(sub-d).toLocaleString('es-CL')}`;
        }

        function obtenerFigurasDeLaTabla() {
            return Array.from(document.getElementById('cuerpoTablaFiguras').getElementsByTagName('tr')).map(fila => {
                let fig = {nombre:'',tamano:'',tamanoPersonalizado:'',material:'',materialPersonalizado:'',cantidad:1,valorUnitario:0,fabricada:false};
                fila.querySelectorAll('input,select').forEach(inp => {
                    const c = inp.dataset.campo;
                    if (c === 'nombre') fig.nombre = inp.value;
                    else if (c === 'tamano') fig.tamano = inp.value;
                    else if (c === 'tamanoPersonalizado') fig.tamanoPersonalizado = inp.value;
                    else if (c === 'material') fig.material = inp.value;
                    else if (c === 'materialPersonalizado') fig.materialPersonalizado = inp.value;
                    else if (c === 'cantidad') fig.cantidad = parseInt(inp.value)||1;
                    else if (c === 'valorUnitario') fig.valorUnitario = parseFloat(inp.value)||0;
                });
                fig.tamanoFinal = fig.tamano === 'Personalizado' ? fig.tamanoPersonalizado : fig.tamano;
                fig.materialFinal = fig.material === 'Otro' ? fig.materialPersonalizado : fig.material;
                fig.valorTotal = fig.cantidad * fig.valorUnitario;
                if (modoEdicion && pedidoEnEdicion && pedidoEnEdicion.figuras) {
                    const orig = pedidoEnEdicion.figuras.find(f => f.nombre === fig.nombre);
                    if (orig) { fig.fabricada = orig.fabricada||false; fig.hitos = orig.hitos||null; }
                }
                return fig;
            }).filter(f => f.nombre);
        }

        function guardarPedido(event) {
            event.preventDefault();
            const figuras = obtenerFigurasDeLaTabla();
            if (!figuras.length) { alert('Agrega al menos una figura'); return; }
            const fecha = new Date().toISOString();
            const nombre = document.getElementById('nombre').value, apellido = document.getElementById('apellido').value;
            const sub = figuras.reduce((s,f) => s+f.valorTotal, 0);
            const desc = parseFloat(document.getElementById('descuentoPorcentaje').value)||0;
            const d = (sub*desc)/100, total = sub-d;

            if (modoEdicion && pedidoEnEdicion) {
                const act = {...pedidoEnEdicion, nombre, apellido, nombreCompleto:`${nombre} ${apellido}`, celular:document.getElementById('celular').value, instagram:document.getElementById('instagram').value, email:document.getElementById('email').value, direccion:document.getElementById('direccion').value, comuna:document.getElementById('comuna').value, ubicacion:document.getElementById('ubicacion').value, estadoPago:document.getElementById('estadoPago').value, figuras, subtotal:sub, descuentoPorcentaje:desc, descuento:d, totalFinal:total, observaciones:document.getElementById('observaciones').value, imagenes:[...imagenesTemp], fechaModificacion:fecha};
                const idx = pedidos.findIndex(p => p.id === pedidoEnEdicion.id);
                if (idx !== -1) pedidos[idx] = act;
                actualizarPedidoEnNube(act).then(() => { cerrarFormulario(); renderizarPedidos(); });
            } else {
                const nuevo = {id:Date.now(), nombre, apellido, nombreCompleto:`${nombre} ${apellido}`, celular:document.getElementById('celular').value, instagram:document.getElementById('instagram').value, email:document.getElementById('email').value, direccion:document.getElementById('direccion').value, comuna:document.getElementById('comuna').value, ubicacion:document.getElementById('ubicacion').value, estadoPago:document.getElementById('estadoPago').value, figuras, subtotal:sub, descuentoPorcentaje:desc, descuento:d, totalFinal:total, observaciones:document.getElementById('observaciones').value, imagenes:[...imagenesTemp], fechaPedido:fecha, estado:'recibido', timeline:[{etapa:'Pedido Recibido',completado:true,fecha},{etapa:'En Fabricaci√≥n',completado:false,fecha:null},{etapa:'En Revisi√≥n',completado:false,fecha:null},{etapa:'Listo para Entrega',completado:false,fecha:null},{etapa:'Entregado',completado:false,fecha:null}]};
                pedidos.push(nuevo);
                guardarPedidoEnNube(nuevo).then(() => { cerrarFormulario(); renderizarPedidos(); });
            }
        }

        function filtrarPedidos(filtro) {
            filtroActual = filtro;
            document.querySelectorAll('.filtro-btn').forEach(b => b.classList.remove('activo'));
            event.target.classList.add('activo');
            if (terminoBusqueda) buscarPedidos(terminoBusqueda); else renderizarPedidos();
        }

        function renderizarPedidos() {
            const lista = document.getElementById('listaPedidos');
            let mostrar = terminoBusqueda ? pedidosFiltrados : (filtroActual !== 'todos' ? pedidos.filter(p => p.estado === filtroActual) : pedidos);
            if (!mostrar.length) { lista.innerHTML = `<div class="card"><div class="vacio"><div class="vacio-icono">${terminoBusqueda?'üîç':'üì¶'}</div><p>${terminoBusqueda?'Sin resultados':'No hay pedidos'}</p></div></div>`; return; }
            lista.innerHTML = '';
            mostrar.forEach(p => {
                const card = document.createElement('div'); card.className = 'card';
                const estadoTextos = {recibido:'Pedido Recibido',fabricacion:'En Fabricaci√≥n',revision:'En Revisi√≥n',listo:'Listo para Entrega',entregado:'Entregado'};
                const nombre = p.nombreCompleto || `${p.nombre||''} ${p.apellido||''}`;
                const fig1 = p.figuras&&p.figuras.length ? p.figuras[0].nombre : 'Pedido';
                card.innerHTML = `
                    <div class="card-imagen">${p.imagenes&&p.imagenes.length ? `<img src="${p.imagenes[0]}">` : 'üé®'}</div>
                    <div class="card-contenido">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
                            <span style="font-size:12px;color:#9ca3af;font-weight:600">#${p.id}</span>
                            <span class="estado-badge estado-${p.estado}">${estadoTextos[p.estado]}</span>
                        </div>
                        <div class="card-titulo">${fig1}</div>
                        <div class="card-info"><strong>Cliente:</strong> ${nombre}</div>
                        <div class="card-info"><strong>Total:</strong> $${(p.totalFinal||0).toLocaleString('es-CL')}</div>
                        <div class="card-info"><strong>Comuna:</strong> ${p.comuna||'N/A'}</div>
                        <div class="card-info"><strong>Fecha:</strong> ${new Date(p.fechaPedido).toLocaleDateString()}</div>
                        <div class="form-grupo"><select class="form-input" onchange="cambiarEstado(${p.id}, this.value)"><option value="recibido" ${p.estado==='recibido'?'selected':''}>üì• Recibido</option><option value="fabricacion" ${p.estado==='fabricacion'?'selected':''}>üî® En Fabricaci√≥n</option><option value="revision" ${p.estado==='revision'?'selected':''}>üîç En Revisi√≥n</option><option value="listo" ${p.estado==='listo'?'selected':''}>‚úÖ Listo para Entrega</option><option value="entregado" ${p.estado==='entregado'?'selected':''}>üì¶ Entregado</option></select></div>
                        <div class="card-acciones">
                            <button class="btn btn-ver" onclick="verDetalle(${p.id})">Ver Detalle</button>
                            <button class="btn btn-link" onclick="mostrarFormulario(${p.id})" style="background:#f59e0b">‚úèÔ∏è</button>
                            <button class="btn btn-imprimir" onclick="imprimirPedidoDirecto(${p.id})">üñ®Ô∏è</button>
                            <button class="btn btn-eliminar" onclick="eliminarPedido(${p.id})">üóëÔ∏è</button>
                        </div>
                    </div>`;
                lista.appendChild(card);
            });
        }

        function cambiarEstado(id, nuevoEstado) {
            const fecha = new Date().toISOString();
            pedidos = pedidos.map(p => {
                if (p.id !== id) return p;
                const tl = [...p.timeline];
                const idx = {fabricacion:1,revision:2,listo:3,entregado:4}[nuevoEstado];
                if (idx !== undefined) for(let i=1;i<=idx;i++) if(!tl[i].completado) tl[i] = {...tl[i], completado:true, fecha};
                const act = {...p, estado:nuevoEstado, timeline:tl};
                actualizarPedidoEnNube(act);
                return act;
            });
            renderizarPedidos();
        }

        function eliminarPedido(id) {
            if (confirm('¬øEliminar este pedido?')) {
                pedidos = pedidos.filter(p => p.id !== id);
                eliminarPedidoEnNube(id).then(() => renderizarPedidos());
            }
        }

        function verDetalle(id) {
            const p = pedidos.find(x => x.id === id);
            if (!p) return;
            pedidoActual = p;
            if (p.figuras) p.figuras.forEach(fig => initHitos(fig));
            const titulo = p.figuras&&p.figuras.length ? p.figuras[0].nombre : 'Pedido';
            document.getElementById('detalleTitulo').textContent = titulo;
            document.querySelector('.link-seguimiento').style.display = 'block';
            document.getElementById('linkSeguimiento').value = generarLinkSeguimiento(p.id);
            const estadoTextos = {recibido:'Pedido Recibido',fabricacion:'En Fabricaci√≥n',revision:'En Revisi√≥n',listo:'Listo para Entrega',entregado:'Entregado'};
            const fabricadas = p.figuras ? p.figuras.filter(f=>f.fabricada).length : 0;
            const totalFigs = p.figuras ? p.figuras.length : 0;
            const pctFigs = totalFigs ? Math.round((fabricadas/totalFigs)*100) : 0;

            let figurasHTML = '';
            if (p.figuras && p.figuras.length) {
                figurasHTML = `
                    <div class="progreso-figuras">
                        <span style="font-weight:600;color:#374151">Progreso general:</span>
                        <div class="progreso-barra"><div class="progreso-relleno" style="width:${pctFigs}%"></div></div>
                        <span class="badge-progreso">${fabricadas}/${totalFigs}</span>
                    </div>
                    ${p.figuras.map((fig, idx) => `
                        <div class="figura-item ${fig.fabricada?'completada':''}">
                            <div class="figura-item-header">
                                <input type="checkbox" class="check-fabricada" ${fig.fabricada?'checked':''} onchange="toggleFiguraFabricada(${p.id},${idx})">
                                <div class="figura-info ${fig.fabricada?'figura-fabricada':''}">
                                    <div style="font-weight:600;font-size:15px">${fig.nombre}</div>
                                    <div style="font-size:13px;color:#6b7280">${fig.tamanoFinal||fig.tamano} ‚Ä¢ ${fig.materialFinal||fig.material} ‚Ä¢ Cant: ${fig.cantidad} ‚Ä¢ $${fig.valorTotal.toLocaleString('es-CL')}</div>
                                </div>
                            </div>
                            ${renderHitosFigura(p.id, idx, fig)}
                        </div>`).join('')}
                    <div style="margin-top:15px;background:#f9fafb;padding:15px;border-radius:8px">
                        <div style="display:flex;justify-content:space-between;padding:5px 0"><span>Subtotal:</span><strong>$${p.subtotal.toLocaleString('es-CL')}</strong></div>
                        ${p.descuentoPorcentaje>0?`<div style="display:flex;justify-content:space-between;padding:5px 0;color:#f59e0b"><span>Descuento (${p.descuentoPorcentaje}%):</span><strong>-$${p.descuento.toLocaleString('es-CL')}</strong></div>`:''}
                        <div style="display:flex;justify-content:space-between;padding:10px 0;border-top:2px solid #e5e7eb;font-size:18px;color:#7c3aed"><span><strong>TOTAL:</strong></span><strong>$${p.totalFinal.toLocaleString('es-CL')}</strong></div>
                    </div>`;
            }

            let tlHTML = p.timeline.map((item, i) => {
                const last = i === p.timeline.length-1;
                return `<div class="timeline-item"><div class="timeline-punto ${item.completado?'completado':'pendiente'}">${item.completado?'‚úì':(i+1)}</div><div class="timeline-contenido"><div class="timeline-etapa ${item.completado?'completado':'pendiente'}">${item.etapa}</div><div class="timeline-fecha">${item.completado&&item.fecha?new Date(item.fecha).toLocaleDateString():'Pendiente'}</div></div></div>${!last?`<div class="timeline-linea ${item.completado?'completado':''}"></div>`:''}`;
            }).join('');

            let imgsHTML = p.imagenes&&p.imagenes.length ? `<div class="seccion-titulo">Im√°genes</div><div class="imagenes-preview">${p.imagenes.map(img=>`<div class="imagen-preview"><img src="${img}"></div>`).join('')}</div>` : '';

            document.getElementById('detalleContenido').innerHTML = `
                <div class="seccion-titulo">Cliente</div>
                <div class="card-info"><strong>Nombre:</strong> ${p.nombre||''} ${p.apellido||''}</div>
                <div class="card-info"><strong>Celular:</strong> ${p.celular||'N/A'}</div>
                ${p.instagram?`<div class="card-info"><strong>Instagram:</strong> <a href="https://instagram.com/${p.instagram.replace('@','')}" target="_blank" style="color:#9333ea">${p.instagram}</a></div>`:''}
                ${p.email?`<div class="card-info"><strong>Email:</strong> ${p.email}</div>`:''}
                <div class="card-info"><strong>Direcci√≥n:</strong> ${p.direccion||'N/A'}</div>
                <div class="card-info"><strong>Comuna:</strong> ${p.comuna||'N/A'}</div>
                <div class="card-info"><strong>Pago:</strong> <span style="color:${p.estadoPago==='Pagado'?'#10b981':'#f59e0b'};font-weight:bold">${p.estadoPago||'N/A'}</span></div>
                <button class="btn btn-link" onclick="cerrarDetalle();mostrarFormulario(${p.id})" style="width:100%;margin-top:10px;background:#f59e0b">‚úèÔ∏è Editar Pedido</button>
                <div class="seccion-titulo">Figuras y Proceso</div>
                ${figurasHTML}
                ${p.observaciones?`<div style="margin-top:15px;background:#f9fafb;padding:10px;border-radius:8px"><strong>Observaciones:</strong><p style="margin-top:5px">${p.observaciones}</p></div>`:''}
                ${imgsHTML}
                <div class="seccion-titulo">Estado</div>
                ${p.estado!=='entregado'?`<select class="form-input" onchange="cambiarEstadoDetalle(this.value)"><option value="recibido" ${p.estado==='recibido'?'selected':''}>üì• Pedido Recibido</option><option value="fabricacion" ${p.estado==='fabricacion'?'selected':''}>üî® En Fabricaci√≥n</option><option value="revision" ${p.estado==='revision'?'selected':''}>üîç En Revisi√≥n</option><option value="listo" ${p.estado==='listo'?'selected':''}>‚úÖ Listo para Entrega</option><option value="entregado" ${p.estado==='entregado'?'selected':''}>üì¶ Entregado</option></select>`:`<div style="background:#d1fae5;padding:15px;border-radius:10px;text-align:center;color:#065f46;font-weight:bold">‚úì Entregado</div>`}
                <div class="seccion-titulo">L√≠nea de Tiempo</div>
                <div class="timeline">${tlHTML}</div>`;

            document.getElementById('modalDetalle').classList.add('activo');
        }

        function toggleFiguraFabricada(pedidoId, idx) {
            const p = pedidos.find(x => x.id === pedidoId);
            if (!p || !p.figuras || !p.figuras[idx]) return;
            p.figuras[idx].fabricada = !p.figuras[idx].fabricada;
            actualizarPedidoEnNube(p);
            verDetalle(pedidoId);
        }

        function cambiarEstadoDetalle(nuevoEstado) { cambiarEstado(pedidoActual.id, nuevoEstado); cerrarDetalle(); }
        function cerrarDetalle() { document.getElementById('modalDetalle').classList.remove('activo'); }

        function imprimirPedidoDirecto(id) { const p = pedidos.find(x => x.id === id); if(p) generarPaginaImpresion(p); }
        function imprimirPedido() { if(pedidoActual) generarPaginaImpresion(pedidoActual); }
        function imprimirEtiquetaEnvio() { if(pedidoActual) generarEtiquetaEnvio(pedidoActual); }

        function generarEtiquetaEnvio(p) {
            document.getElementById('paginaImpresion').innerHTML = `
                <div style="width:10cm;height:15cm;padding:1cm;font-family:Arial,sans-serif">
                    <div style="text-align:center;border-bottom:3px solid #2c3e50;padding-bottom:15px;margin-bottom:20px">
                        <h1 style="margin:0;font-size:24px;color:#2c3e50">üßô‚Äç‚ôÇÔ∏è Emporio de Hagrid</h1>
                    </div>
                    <div style="border:2px solid #2c3e50;padding:15px;border-radius:10px">
                        <div style="background:#2c3e50;color:white;padding:8px;margin:-15px -15px 15px;border-radius:8px 8px 0 0"><strong>üìç DESTINATARIO</strong></div>
                        <div style="font-size:18px;font-weight:bold;margin-bottom:10px">${p.nombre} ${p.apellido||''}</div>
                        <div style="font-size:14px">üì± ${p.celular||'N/A'}<br>üì´ ${p.direccion||'N/A'}<br><strong>${p.comuna||'N/A'}, ${p.ubicacion||'Chile'}</strong></div>
                    </div>
                    <div style="background:#ecf0f1;padding:12px;border-radius:8px;margin-top:15px">
                        <strong>Pedido #${p.id}</strong> ‚Äî ${new Date(p.fechaPedido).toLocaleDateString('es-CL')}
                    </div>
                    ${p.estadoPago==='Por Pagar'?'<div style="background:#fff3cd;border:2px solid #ffc107;padding:8px;border-radius:5px;margin-top:10px;text-align:center"><strong>‚ö†Ô∏è PAGO PENDIENTE</strong></div>':''}
                </div>`;
            window.print();
        }

        function generarPaginaImpresion(p) {
            const estadoTextos = {recibido:'Pedido Recibido',fabricacion:'En Fabricaci√≥n',revision:'En Revisi√≥n',listo:'Listo para Entrega',entregado:'Entregado'};
            document.getElementById('paginaImpresion').innerHTML = `
                <div class="impresion-header"><h1>üßô‚Äç‚ôÇÔ∏è Emporio de Hagrid</h1><p style="font-size:18px;color:#6b7280">Orden de Pedido</p></div>
                <div style="text-align:right;margin-bottom:20px;color:#6b7280">
                    <strong>Pedido #${p.id}</strong><br>
                    Fecha: ${new Date(p.fechaPedido).toLocaleDateString()}<br>
                    Estado: <strong style="color:#7c3aed">${estadoTextos[p.estado]}</strong><br>
                    <span style="color:${p.estadoPago==='Pagado'?'#10b981':'#f59e0b'};font-weight:bold">${p.estadoPago}</span>
                </div>
                <div class="impresion-seccion"><h3>üë§ Cliente</h3>
                    <table class="impresion-tabla">
                        <tr><td>Nombre:</td><td>${p.nombre} ${p.apellido||''}</td></tr>
                        <tr><td>Celular:</td><td>${p.celular||'N/A'}</td></tr>
                        ${p.instagram?`<tr><td>Instagram:</td><td>${p.instagram}</td></tr>`:''}
                        ${p.email?`<tr><td>Email:</td><td>${p.email}</td></tr>`:''}
                        <tr><td>Direcci√≥n:</td><td>${p.direccion||'N/A'}</td></tr>
                        <tr><td>Comuna:</td><td>${p.comuna||'N/A'}</td></tr>
                        <tr><td>Pago:</td><td><strong style="color:${p.estadoPago==='Pagado'?'#10b981':'#f59e0b'}">${p.estadoPago}</strong></td></tr>
                    </table>
                </div>
                <div class="impresion-seccion"><h3>üé® Figuras</h3>
                    <table style="width:100%;border-collapse:collapse">
                        <thead><tr style="background:#f3f4f6"><th style="padding:8px;border:1px solid #e5e7eb">Figura</th><th style="padding:8px;border:1px solid #e5e7eb">Tama√±o</th><th style="padding:8px;border:1px solid #e5e7eb">Material</th><th style="padding:8px;border:1px solid #e5e7eb">Cant.</th><th style="padding:8px;border:1px solid #e5e7eb">Total</th></tr></thead>
                        <tbody>${(p.figuras||[]).map(f=>`<tr><td style="padding:8px;border:1px solid #e5e7eb">${f.nombre}</td><td style="padding:8px;border:1px solid #e5e7eb">${f.tamanoFinal||f.tamano}</td><td style="padding:8px;border:1px solid #e5e7eb">${f.materialFinal||f.material}</td><td style="padding:8px;border:1px solid #e5e7eb;text-align:center">${f.cantidad}</td><td style="padding:8px;border:1px solid #e5e7eb;text-align:right">$${f.valorTotal.toLocaleString('es-CL')}</td></tr>`).join('')}</tbody>
                    </table>
                    <div style="text-align:right;margin-top:15px;font-size:20px;color:#7c3aed"><strong>TOTAL: $${p.totalFinal.toLocaleString('es-CL')}</strong></div>
                </div>
                ${p.observaciones?`<div class="impresion-seccion"><h3>üìù Observaciones</h3><p>${p.observaciones}</p></div>`:''}
                <div class="impresion-pie"><p><strong>Emporio de Hagrid</strong> ‚Äî ${new Date().toLocaleDateString()}</p></div>`;
            window.print();
        }

        function mostrarSeguimientoPublico(pedidoId) {
            const p = pedidos.find(x => x.id === pedidoId);
            if (!p) { document.getElementById('contenidoSeguimiento').innerHTML = '<div class="vacio"><div class="vacio-icono">‚ùå</div><p>Pedido no encontrado</p></div>'; }
            else {
                const estadoTextos = {recibido:'Pedido Recibido',fabricacion:'En Fabricaci√≥n',revision:'En Revisi√≥n',listo:'Listo para Entrega',entregado:'Entregado'};
                document.getElementById('contenidoSeguimiento').innerHTML = `
                    <div style="text-align:center;margin-bottom:30px"><h2>Pedido #${p.id}</h2><div style="display:inline-block;padding:10px 20px;background:#f3f4f6;border-radius:20px;font-weight:600;color:#7c3aed">${estadoTextos[p.estado]}</div></div>
                    <div style="background:#f9fafb;padding:20px;border-radius:10px;margin-bottom:30px">
                        <h3 style="margin-bottom:15px">üìã Progreso</h3>
                        <div class="timeline">${p.timeline.map((item,i)=>{const last=i===p.timeline.length-1;return `<div class="timeline-item"><div class="timeline-punto ${item.completado?'completado':'pendiente'}">${item.completado?'‚úì':(i+1)}</div><div class="timeline-contenido"><div class="timeline-etapa ${item.completado?'completado':'pendiente'}">${item.etapa}</div><div class="timeline-fecha">${item.completado&&item.fecha?new Date(item.fecha).toLocaleDateString():'Pendiente'}</div></div></div>${!last?`<div class="timeline-linea ${item.completado?'completado':''}"></div>`:''}`}).join('')}</div>
                    </div>
                    <div style="text-align:center;margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb;color:#6b7280"><p>¬øDudas? Cont√°ctanos por Instagram</p></div>`;
            }
            document.getElementById('paginaSeguimiento').classList.add('activo');
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.container').style.display = 'none';
        }
    </script>
</body>
</html>
