<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emporio de Hagrid - Pedidos v2.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        .header {
            background: #2c3e50;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 3px solid #34495e;
        }
        
        .header h1 {
            color: #ecf0f1;
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #bdc3c7;
            font-size: 14px;
        }
        
        .container {
            padding: 20px;
        }
        
        .btn-nuevo {
            background: #34495e;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-bottom: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(52,73,94,0.3);
        }
        
        .btn-nuevo:active {
            transform: scale(0.98);
        }
        
        .filtros {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .filtro-btn {
            background: white;
            border: 2px solid #e5e7eb;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
        }
        
        .filtro-btn.activo {
            background: #34495e;
            color: white;
            border-color: #34495e;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card-imagen {
            width: 100%;
            height: 200px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
        }
        
        .card-imagen img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .card-contenido {
            padding: 15px;
        }
        
        .card-titulo {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 10px;
        }
        
        .card-info {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .estado-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .estado-recibido { background: #dbeafe; color: #1e40af; }
        .estado-fabricacion { background: #fef3c7; color: #92400e; }
        .estado-revision { background: #fed7aa; color: #9a3412; }
        .estado-listo { background: #d1fae5; color: #065f46; }
        .estado-entregado { background: #e5e7eb; color: #374151; }
        
        .card-acciones {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-ver {
            background: #34495e;
            color: white;
        }
        
        .btn-eliminar {
            background: #c0392b;
            color: white;
            flex: 0 0 50px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.activo {
            display: block;
        }
        
        .modal-contenido {
            background: white;
            margin: 20px;
            border-radius: 15px;
            padding: 20px;
            max-width: 600px;
            margin: 20px auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-titulo {
            font-size: 22px;
            font-weight: bold;
            color: #1f2937;
        }
        
        .btn-cerrar {
            background: none;
            border: none;
            font-size: 30px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
        }
        
        .form-grupo {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #9333ea;
        }
        
        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }
        
        .seccion-titulo {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin: 20px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background: #f9fafb;
        }
        
        .upload-area:active {
            background: #f3f4f6;
        }
        
        .imagenes-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .imagen-preview {
            position: relative;
            padding-top: 100%;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .imagen-preview img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .imagen-preview-eliminar {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            z-index: 10;
        }
        
        .form-botones {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        .btn-cancelar {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-guardar {
            background: #27ae60;
            color: white;
        }
        
        .timeline {
            margin-top: 20px;
        }
        
        .timeline-item {
            display: flex;
            margin-bottom: 20px;
        }
        
        .timeline-punto {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            margin-right: 15px;
        }
        
        .timeline-punto.completado {
            background: #10b981;
            color: white;
        }
        
        .timeline-punto.pendiente {
            background: #e5e7eb;
            color: #9ca3af;
        }
        
        .timeline-linea {
            width: 2px;
            background: #e5e7eb;
            margin-left: 19px;
            margin-top: -20px;
            margin-bottom: 0px;
            height: 20px;
        }
        
        .timeline-linea.completado {
            background: #10b981;
        }
        
        .timeline-contenido {
            flex: 1;
        }
        
        .timeline-etapa {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .timeline-etapa.completado {
            color: #059669;
        }
        
        .timeline-etapa.pendiente {
            color: #9ca3af;
        }
        
        .timeline-fecha {
            font-size: 12px;
            color: #6b7280;
        }
        
        .vacio {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .vacio-icono {
            font-size: 60px;
            margin-bottom: 15px;
        }
        
        select.form-input {
            cursor: pointer;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn-imprimir {
            background: #10b981;
            color: white;
        }
        
        /* Estilos para impresi√≥n */
        @media print {
            body {
                background: white;
            }
            
            .header, .container, .modal {
                display: none;
            }
            
            .pagina-impresion {
                display: block !important;
            }
            
            .no-imprimir {
                display: none !important;
            }
        }
        
        .pagina-impresion {
            display: none;
            padding: 40px;
            background: white;
        }
        
        .impresion-header {
            text-align: center;
            border-bottom: 3px solid #9333ea;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .impresion-header h1 {
            color: #7c3aed;
            font-size: 32px;
            margin-bottom: 5px;
        }
        
        .impresion-seccion {
            margin-bottom: 30px;
            page-break-inside: avoid;
        }
        
        .impresion-seccion h3 {
            background: #f3f4f6;
            padding: 10px 15px;
            border-left: 4px solid #9333ea;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .impresion-tabla {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .impresion-tabla td {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .impresion-tabla td:first-child {
            font-weight: bold;
            width: 180px;
            color: #374151;
        }
        
        .impresion-imagenes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .impresion-imagen {
            text-align: center;
            page-break-inside: avoid;
        }
        
        .impresion-imagen img {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .impresion-imagen p {
            margin-top: 8px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .impresion-timeline {
            margin-top: 20px;
        }
        
        .impresion-timeline-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .impresion-timeline-check {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }
        
        .impresion-timeline-check.completado {
            background: #10b981;
            color: white;
        }
        
        .impresion-timeline-check.pendiente {
            background: #e5e7eb;
            color: #9ca3af;
        }
        
        .impresion-pie {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
            text-align: center;
            color: #6b7280;
            font-size: 12px;
        }
        
        .tabla-figuras {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .tabla-figuras th {
            background: #f3f4f6;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #e5e7eb;
        }
        
        .tabla-figuras td {
            padding: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .tabla-figuras input,
        .tabla-figuras select {
            width: 100%;
            padding: 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .tabla-figuras input:focus,
        .tabla-figuras select:focus {
            outline: none;
            border-color: #9333ea;
        }
        
        .btn-agregar-figura {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .btn-eliminar-fila {
            background: #ef4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .resumen-total {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .resumen-linea {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .resumen-linea:last-child {
            border-bottom: none;
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            padding-top: 12px;
        }
        
        .input-pequeno {
            width: 80px !important;
        }
        
        .col-figura { width: 30%; }
        .col-tamano { width: 15%; }
        .col-material { width: 15%; }
        .col-cantidad { width: 10%; }
        .col-valor { width: 12%; }
        .col-total { width: 12%; }
        .col-accion { width: 6%; }
        
        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #34495e;
        }
        
        .stat-card.pendientes {
            border-left-color: #f59e0b;
        }
        
        .stat-card.completados {
            border-left-color: #10b981;
        }
        
        .stat-card.clientes {
            border-left-color: #3b82f6;
        }
        
        .stat-numero {
            font-size: 36px;
            font-weight: bold;
            color: #1f2937;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 14px;
        }
        
        .stat-icono {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0;
            overflow-x: auto;
        }
        
        .tab {
            background: none;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        
        .tab.activo {
            color: #34495e;
            border-bottom-color: #34495e;
        }
        
        .btn-link {
            background: #3b82f6;
            color: white;
        }
        
        .check-fabricada {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-right: 8px;
            accent-color: #10b981;
        }
        
        .figura-fabricada {
            text-decoration: line-through;
            opacity: 0.6;
            color: #10b981;
        }
        
        .figura-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 2px solid #f3f4f6;
            transition: all 0.2s;
        }
        
        .figura-item:hover {
            border-color: #e5e7eb;
        }
        
        .figura-item.completada {
            background: #f0fdf4;
            border-color: #86efac;
        }
        
        .figura-info {
            flex: 1;
        }
        
        .progreso-figuras {
            background: #f3f4f6;
            padding: 12px 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progreso-barra {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 0 15px;
        }
        
        .progreso-relleno {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
        }
        
        .badge-progreso {
            background: #10b981;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .tiempo-badge {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .btn-tiempo {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
            font-weight: 600;
        }
        
        .btn-tiempo.iniciado {
            background: #f59e0b;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .estadisticas-tiempo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
        }
        
        .estadisticas-tiempo h4 {
            margin: 0 0 15px 0;
            font-size: 16px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .cronometro-visual {
            font-size: 24px;
            font-weight: bold;
            color: #f59e0b;
            text-align: center;
            padding: 10px;
            background: #fffbeb;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
        
        .seccion-envio {
            background: #f0fdf4;
            border: 2px solid #86efac;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .seccion-envio h3 {
            color: #166534;
            margin: 0 0 15px 0;
            font-size: 18px;
        }
        
        .info-envio {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .info-envio-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .info-envio-item:last-child {
            border-bottom: none;
        }
        
        .btn-agregar-envio {
            background: #10b981;
            color: white;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .modal-envio {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 2000;
            overflow-y: auto;
        }
        
        .modal-envio.activo {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-envio-contenido {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            margin: 20px;
        }
        
        .hitos-container {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .hitos-titulo {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 10px;
        }
        
        .hitos-lista {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .hito-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #e5e7eb;
        }
        
        .hito-item:hover {
            border-color: #d1d5db;
        }
        
        .hito-item.completado {
            background: #ecfdf5;
            border-color: #6ee7b7;
        }
        
        .hito-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            cursor: pointer;
            accent-color: #10b981;
        }
        
        .hito-label {
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            user-select: none;
        }
        
        .hito-item.completado .hito-label {
            color: #059669;
        }
        
        .progreso-hitos {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }
        
        .progreso-hitos-barra {
            flex: 1;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progreso-hitos-relleno {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s;
        }
        
        .progreso-hitos-texto {
            font-size: 11px;
            font-weight: 600;
            color: #10b981;
        }
        
        .link-seguimiento {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px dashed #d1d5db;
        }
        
        .link-seguimiento input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        
        .cliente-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #9333ea;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cliente-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }
        
        .cliente-nombre {
            font-weight: bold;
            font-size: 16px;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .cliente-info {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 3px;
        }
        
        .badge-pedidos {
            display: inline-block;
            background: #34495e;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .indicador-nube {
            position: fixed;
            top: 70px;
            right: 20px;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            font-weight: 600;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .indicador-nube.conectado {
            border-left: 4px solid #10b981;
            color: #10b981;
        }
        
        .indicador-nube.desconectado {
            border-left: 4px solid #f59e0b;
            color: #f59e0b;
        }
        
        .btn-sincronizar {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .buscador {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .buscador-input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .buscador-input:focus {
            outline: none;
            border-color: #34495e;
            box-shadow: 0 0 0 3px rgba(52,73,94,0.1);
        }
        
        .buscador-contenedor {
            position: relative;
        }
        
        .buscador-icono {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: #9ca3af;
        }
        
        .btn-limpiar-busqueda {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }
        
        .btn-limpiar-busqueda.visible {
            display: block;
        }
        
        .resultados-busqueda {
            margin-top: 10px;
            font-size: 14px;
            color: #6b7280;
            font-weight: 600;
        }
        
        .highlight {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üßô‚Äç‚ôÇÔ∏è Emporio de Hagrid</h1>
        <p>Gesti√≥n de Pedidos</p>
    </div>
    
    <!-- Indicador de conexi√≥n con Google Sheets -->
    <div class="indicador-nube conectado" id="indicadorNube">
        <span>‚òÅÔ∏è</span>
        <span id="textoIndicador">Conectado a Google Sheets</span>
        <button class="btn-sincronizar" onclick="sincronizarManual()">üîÑ Sincronizar</button>
    </div>

    <div class="container">
        <!-- Tabs de Navegaci√≥n -->
        <div class="tabs">
            <button class="tab activo" onclick="cambiarTab('pedidos')">üì¶ Pedidos</button>
            <button class="tab" onclick="cambiarTab('clientes')">üë• Clientes</button>
            <button class="tab" onclick="cambiarTab('dashboard')">üìä Dashboard</button>
        </div>
        
        <!-- Vista de Pedidos -->
        <div id="vistaPedidos">
            <button class="btn-nuevo" onclick="mostrarFormulario()">+ Nuevo Pedido</button>
            
            <!-- Buscador Avanzado -->
            <div class="buscador">
                <div class="buscador-contenedor">
                    <span class="buscador-icono">üîç</span>
                    <input 
                        type="text" 
                        class="buscador-input" 
                        id="inputBusqueda"
                        placeholder="Buscar por nombre, Instagram, celular, pedido #, comuna, figura..." 
                        oninput="buscarPedidos(this.value)"
                    >
                    <button class="btn-limpiar-busqueda" id="btnLimpiarBusqueda" onclick="limpiarBusqueda()">‚úï Limpiar</button>
                </div>
                <div class="resultados-busqueda" id="resultadosBusqueda"></div>
            </div>
            
            <div class="filtros" id="filtros">
                <button class="filtro-btn activo" onclick="filtrarPedidos('todos')">Todos</button>
                <button class="filtro-btn" onclick="filtrarPedidos('recibido')">Recibidos</button>
                <button class="filtro-btn" onclick="filtrarPedidos('fabricacion')">Fabricaci√≥n</button>
                <button class="filtro-btn" onclick="filtrarPedidos('entregado')">Entregados</button>
            </div>
            
            <div id="listaPedidos"></div>
        </div>
        
        <!-- Vista de Clientes -->
        <div id="vistaClientes" style="display: none;">
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h2 style="color: #7c3aed; margin-bottom: 10px;">üë• Historial de Clientes</h2>
                <p style="color: #6b7280;">Haz clic en un cliente para ver su historial completo de pedidos</p>
            </div>
            <div id="listaClientes"></div>
        </div>
        
        <!-- Vista Dashboard -->
        <div id="vistaDashboard" style="display: none;">
            <h2 style="color: #7c3aed; margin-bottom: 20px; font-size: 24px;">üìä Dashboard de Ventas</h2>
            <div class="dashboard" id="dashboardStats"></div>
            <div id="graficoPedidos"></div>
        </div>
    </div>

    <!-- Modal Formulario -->
    <div class="modal" id="modalFormulario">
        <div class="modal-contenido">
            <div class="modal-header">
                <h2 class="modal-titulo">Nuevo Pedido</h2>
                <button class="btn-cerrar" onclick="cerrarFormulario()">√ó</button>
            </div>
            
            <form id="formPedido" onsubmit="guardarPedido(event)">
                <div class="seccion-titulo">Datos del Cliente</div>
                
                <div class="grid-2">
                    <div class="form-grupo">
                        <label class="form-label">Nombre *</label>
                        <input type="text" class="form-input" id="nombre" required>
                    </div>
                    
                    <div class="form-grupo">
                        <label class="form-label">Apellido *</label>
                        <input type="text" class="form-input" id="apellido" required>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-grupo">
                        <label class="form-label">Celular *</label>
                        <input type="tel" class="form-input" id="celular" required placeholder="+56 9 1234 5678">
                    </div>
                    
                    <div class="form-grupo">
                        <label class="form-label">Instagram</label>
                        <input type="text" class="form-input" id="instagram" placeholder="@usuario_instagram">
                    </div>
                </div>
                
                <div class="form-grupo">
                    <label class="form-label">Correo Electr√≥nico</label>
                    <input type="email" class="form-input" id="email" placeholder="ejemplo@correo.com">
                </div>
                
                <div class="form-grupo">
                    <label class="form-label">Direcci√≥n de Entrega *</label>
                    <input type="text" class="form-input" id="direccion" required placeholder="Calle y n√∫mero">
                </div>
                
                <div class="grid-2">
                    <div class="form-grupo">
                        <label class="form-label">Comuna *</label>
                        <select class="form-input" id="comuna" required>
                            <option value="">Seleccionar comuna...</option>
                            <optgroup label="Santiago">
                                <option value="Cerrillos">Cerrillos</option>
                                <option value="Cerro Navia">Cerro Navia</option>
                                <option value="Conchal√≠">Conchal√≠</option>
                                <option value="El Bosque">El Bosque</option>
                                <option value="Estaci√≥n Central">Estaci√≥n Central</option>
                                <option value="Huechuraba">Huechuraba</option>
                                <option value="Independencia">Independencia</option>
                                <option value="La Cisterna">La Cisterna</option>
                                <option value="La Florida">La Florida</option>
                                <option value="La Granja">La Granja</option>
                                <option value="La Pintana">La Pintana</option>
                                <option value="La Reina">La Reina</option>
                                <option value="Las Condes">Las Condes</option>
                                <option value="Lo Barnechea">Lo Barnechea</option>
                                <option value="Lo Espejo">Lo Espejo</option>
                                <option value="Lo Prado">Lo Prado</option>
                                <option value="Macul">Macul</option>
                                <option value="Maip√∫">Maip√∫</option>
                                <option value="√ëu√±oa">√ëu√±oa</option>
                                <option value="Pedro Aguirre Cerda">Pedro Aguirre Cerda</option>
                                <option value="Pe√±alol√©n">Pe√±alol√©n</option>
                                <option value="Providencia">Providencia</option>
                                <option value="Pudahuel">Pudahuel</option>
                                <option value="Quilicura">Quilicura</option>
                                <option value="Quinta Normal">Quinta Normal</option>
                                <option value="Recoleta">Recoleta</option>
                                <option value="Renca">Renca</option>
                                <option value="San Joaqu√≠n">San Joaqu√≠n</option>
                                <option value="San Miguel">San Miguel</option>
                                <option value="San Ram√≥n">San Ram√≥n</option>
                                <option value="Santiago Centro">Santiago Centro</option>
                                <option value="Vitacura">Vitacura</option>
                            </optgroup>
                            <optgroup label="Regiones">
                                <option value="Arica">Arica</option>
                                <option value="Iquique">Iquique</option>
                                <option value="Antofagasta">Antofagasta</option>
                                <option value="Calama">Calama</option>
                                <option value="Copiap√≥">Copiap√≥</option>
                                <option value="Vallenar">Vallenar</option>
                                <option value="La Serena">La Serena</option>
                                <option value="Coquimbo">Coquimbo</option>
                                <option value="Valpara√≠so">Valpara√≠so</option>
                                <option value="Vi√±a del Mar">Vi√±a del Mar</option>
                                <option value="Quilpu√©">Quilpu√©</option>
                                <option value="Villa Alemana">Villa Alemana</option>
                                <option value="Rancagua">Rancagua</option>
                                <option value="Talca">Talca</option>
                                <option value="Curic√≥">Curic√≥</option>
                                <option value="Chill√°n">Chill√°n</option>
                                <option value="Concepci√≥n">Concepci√≥n</option>
                                <option value="Talcahuano">Talcahuano</option>
                                <option value="Los √Ångeles">Los √Ångeles</option>
                                <option value="Temuco">Temuco</option>
                                <option value="Valdivia">Valdivia</option>
                                <option value="Osorno">Osorno</option>
                                <option value="Puerto Montt">Puerto Montt</option>
                                <option value="Puerto Varas">Puerto Varas</option>
                                <option value="Coyhaique">Coyhaique</option>
                                <option value="Punta Arenas">Punta Arenas</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="form-grupo">
                        <label class="form-label">Ubicaci√≥n *</label>
                        <select class="form-input" id="ubicacion" required>
                            <option value="">Seleccionar...</option>
                            <option value="Santiago">Santiago</option>
                            <option value="Regi√≥n">Regi√≥n</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-grupo">
                    <label class="form-label">Estado de Pago *</label>
                    <select class="form-input" id="estadoPago" required>
                        <option value="">Seleccionar...</option>
                        <option value="Pagado">Pagado</option>
                        <option value="Por Pagar">Por Pagar</option>
                    </select>
                </div>
                
                <div class="seccion-titulo">Cotizaci√≥n de Figuras</div>
                
                <div style="overflow-x: auto;">
                    <table class="tabla-figuras" id="tablaFiguras">
                        <thead>
                            <tr>
                                <th class="col-figura">Figura</th>
                                <th class="col-tamano">Tama√±o</th>
                                <th class="col-material">Material</th>
                                <th class="col-cantidad">Cant.</th>
                                <th class="col-valor">Valor Unit.</th>
                                <th class="col-total">Total</th>
                                <th class="col-accion"></th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoTablaFiguras">
                            <!-- Filas se agregan din√°micamente -->
                        </tbody>
                    </table>
                </div>
                
                <button type="button" class="btn-agregar-figura" onclick="agregarFilaFigura()">+ Agregar Figura</button>
                
                <div class="resumen-total" id="resumenTotal">
                    <div class="resumen-linea">
                        <span>Subtotal:</span>
                        <span id="subtotalTexto">$0</span>
                    </div>
                    <div class="resumen-linea">
                        <span>Descuento:</span>
                        <div>
                            <input type="number" id="descuentoPorcentaje" value="0" min="0" max="100" 
                                   style="width: 60px; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px;"
                                   oninput="calcularTotales()"> %
                            <span id="descuentoTexto" style="margin-left: 10px;">$0</span>
                        </div>
                    </div>
                    <div class="resumen-linea">
                        <span>TOTAL:</span>
                        <span id="totalFinalTexto">$0</span>
                    </div>
                </div>
                
                <div class="form-grupo" style="margin-top: 20px;">
                    <label class="form-label">Observaciones / Notas Adicionales</label>
                    <textarea class="form-input" id="observaciones" placeholder="Notas sobre el pedido..."></textarea>
                </div>
                
                <div class="seccion-titulo">Im√°genes</div>
                
                <div class="upload-area" onclick="document.getElementById('inputImagenes').click()">
                    <div style="font-size: 40px; margin-bottom: 10px;">üì∑</div>
                    <div style="color: #6b7280;">Toca para subir im√°genes</div>
                </div>
                <input type="file" id="inputImagenes" accept="image/*" multiple style="display: none;" onchange="procesarImagenes(event)">
                
                <div id="imagenesPreview" class="imagenes-preview"></div>
                
                <div class="form-botones">
                    <button type="button" class="btn btn-cancelar" onclick="cerrarFormulario()">Cancelar</button>
                    <button type="submit" class="btn btn-guardar">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalle -->
    <div class="modal" id="modalDetalle">
        <div class="modal-contenido">
            <div class="modal-header">
                <h2 class="modal-titulo" id="detalleTitulo"></h2>
                <button class="btn-cerrar" onclick="cerrarDetalle()">√ó</button>
            </div>
            
            <div id="detalleContenido"></div>
            
            <!-- Link de Seguimiento -->
            <div class="link-seguimiento">
                <strong style="color: #7c3aed;">üîó Link de Seguimiento para el Cliente</strong>
                <p style="font-size: 13px; color: #6b7280; margin: 5px 0;">Comparte este link con tu cliente para que pueda ver el estado de su pedido en tiempo real</p>
                <input type="text" id="linkSeguimiento" readonly onclick="this.select()">
                <button class="btn btn-link" style="width: 100%; margin-top: 5px;" onclick="copiarLinkSeguimiento()">üìã Copiar Link</button>
            </div>
            
            <div class="form-botones">
                <button class="btn btn-imprimir" onclick="imprimirPedido()">üñ®Ô∏è Imprimir</button>
                <button class="btn btn-imprimir" onclick="imprimirEtiquetaEnvio()" style="background: #3498db;">üì¶ Etiqueta de Env√≠o</button>
                <button class="btn btn-ver" onclick="cerrarDetalle()">Volver</button>
            </div>
        </div>
    </div>

    <!-- P√°gina de Impresi√≥n (oculta) -->
    <div class="pagina-impresion" id="paginaImpresion"></div>
    
    <!-- P√°gina de Seguimiento P√∫blico -->
    <div class="modal" id="paginaSeguimiento" style="background: white;">
        <div class="modal-contenido" style="max-width: 800px;">
            <div style="background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%); color: white; padding: 30px; border-radius: 15px 15px 0 0; margin: -20px -20px 20px -20px;">
                <h1 style="margin: 0; font-size: 28px;">üßô‚Äç‚ôÇÔ∏è Emporio de Hagrid</h1>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">Seguimiento de Pedido</p>
            </div>
            <div id="contenidoSeguimiento"></div>
        </div>
    </div>

    <script>
        // URL de tu Google Apps Script
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx4G2esPGqgPdzMrgFCxBQb_i6EY78RB6ebIN4CLnKDYWr5KbQvuLeCMZ_kw4ESevfI/exec';
        
        let pedidos = [];
        let imagenesTemp = [];
        let filtroActual = 'todos';
        let pedidoActual = null;
        let figurasPedido = [];
        let contadorFilas = 0;
        let tabActual = 'pedidos';
        let cargando = false;
        let terminoBusqueda = '';
        let pedidosFiltrados = [];
        let modoEdicion = false;
        let pedidoEnEdicion = null;
        let cronometrosActivos = {}; // Almacenar cron√≥metros activos

        // Cargar pedidos al iniciar
        window.onload = function() {
            mostrarCargando();
            cargarPedidosDesdeNube();
            verificarSeguimiento();
        };
        
        function verificarSeguimiento() {
            const urlParams = new URLSearchParams(window.location.search);
            const pedidoId = urlParams.get('pedido');
            
            if (pedidoId) {
                mostrarSeguimientoPublico(parseInt(pedidoId));
            }
        }
        
        // SISTEMA DE B√öSQUEDA AVANZADA
        function buscarPedidos(termino) {
            terminoBusqueda = termino.toLowerCase().trim();
            const btnLimpiar = document.getElementById('btnLimpiarBusqueda');
            const resultadosDiv = document.getElementById('resultadosBusqueda');
            
            // Mostrar/ocultar bot√≥n de limpiar
            if (terminoBusqueda) {
                btnLimpiar.classList.add('visible');
            } else {
                btnLimpiar.classList.remove('visible');
                resultadosDiv.textContent = '';
                renderizarPedidos();
                return;
            }
            
            // Buscar en todos los campos relevantes
            pedidosFiltrados = pedidos.filter(pedido => {
                // Buscar en ID del pedido
                if (pedido.id.toString().includes(terminoBusqueda)) return true;
                
                // Buscar en nombre completo
                const nombreCompleto = `${pedido.nombre || ''} ${pedido.apellido || ''}`.toLowerCase();
                if (nombreCompleto.includes(terminoBusqueda)) return true;
                
                // Buscar en celular
                if (pedido.celular && pedido.celular.toLowerCase().includes(terminoBusqueda)) return true;
                
                // Buscar en email
                if (pedido.email && pedido.email.toLowerCase().includes(terminoBusqueda)) return true;
                
                // Buscar en comuna
                if (pedido.comuna && pedido.comuna.toLowerCase().includes(terminoBusqueda)) return true;
                
                // Buscar en direcci√≥n
                if (pedido.direccion && pedido.direccion.toLowerCase().includes(terminoBusqueda)) return true;
                
                // Buscar en nombres de figuras
                if (pedido.figuras && pedido.figuras.length > 0) {
                    const tieneEnFiguras = pedido.figuras.some(fig => 
                        fig.nombre && fig.nombre.toLowerCase().includes(terminoBusqueda)
                    );
                    if (tieneEnFiguras) return true;
                }
                
                // Buscar en observaciones
                if (pedido.observaciones && pedido.observaciones.toLowerCase().includes(terminoBusqueda)) return true;
                
                // Buscar en fecha
                const fecha = new Date(pedido.fechaPedido).toLocaleDateString('es-CL');
                if (fecha.includes(terminoBusqueda)) return true;
                
                return false;
            });
            
            // Aplicar filtro de estado si est√° activo
            if (filtroActual !== 'todos') {
                pedidosFiltrados = pedidosFiltrados.filter(p => p.estado === filtroActual);
            }
            
            // Mostrar resultados
            const total = pedidosFiltrados.length;
            if (total === 0) {
                resultadosDiv.innerHTML = '‚ùå No se encontraron resultados para "<span class="highlight">' + termino + '</span>"';
            } else if (total === 1) {
                resultadosDiv.innerHTML = '‚úì 1 pedido encontrado';
            } else {
                resultadosDiv.innerHTML = '‚úì ' + total + ' pedidos encontrados';
            }
            
            renderizarPedidos();
        }
        
        function limpiarBusqueda() {
            terminoBusqueda = '';
            pedidosFiltrados = [];
            document.getElementById('inputBusqueda').value = '';
            document.getElementById('btnLimpiarBusqueda').classList.remove('visible');
            document.getElementById('resultadosBusqueda').textContent = '';
            renderizarPedidos();
        }
        
        function resaltarTexto(texto, termino) {
            if (!termino || !texto) return texto;
            
            const regex = new RegExp(`(${termino})`, 'gi');
            return texto.replace(regex, '<span class="highlight">$1</span>');
        }
        
        function cambiarTab(tab) {
            tabActual = tab;
            
            // Actualizar tabs activos
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('activo'));
            event.target.classList.add('activo');
            
            // Ocultar todas las vistas
            document.getElementById('vistaPedidos').style.display = 'none';
            document.getElementById('vistaClientes').style.display = 'none';
            document.getElementById('vistaDashboard').style.display = 'none';
            
            // Mostrar vista seleccionada
            if (tab === 'pedidos') {
                document.getElementById('vistaPedidos').style.display = 'block';
            } else if (tab === 'clientes') {
                document.getElementById('vistaClientes').style.display = 'block';
                renderizarClientes();
            } else if (tab === 'dashboard') {
                document.getElementById('vistaDashboard').style.display = 'block';
                renderizarDashboard();
            }
        }
        
        function renderizarClientes() {
            const clientesMap = new Map();
            
            // Agrupar pedidos por cliente
            pedidos.forEach(pedido => {
                const nombreCompleto = pedido.nombreCompleto || `${pedido.nombre} ${pedido.apellido}`;
                const celular = pedido.celular || pedido.telefono || 'N/A';
                
                if (!clientesMap.has(celular)) {
                    clientesMap.set(celular, {
                        nombre: nombreCompleto,
                        celular: celular,
                        email: pedido.email || 'N/A',
                        comuna: pedido.comuna || 'N/A',
                        pedidos: []
                    });
                }
                
                clientesMap.get(celular).pedidos.push(pedido);
            });
            
            const listaClientes = document.getElementById('listaClientes');
            
            if (clientesMap.size === 0) {
                listaClientes.innerHTML = `
                    <div class="card">
                        <div class="vacio">
                            <div class="vacio-icono">üë•</div>
                            <p>No hay clientes registrados</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            listaClientes.innerHTML = '';
            
            // Ordenar clientes por n√∫mero de pedidos
            const clientesOrdenados = Array.from(clientesMap.values())
                .sort((a, b) => b.pedidos.length - a.pedidos.length);
            
            clientesOrdenados.forEach(cliente => {
                const totalGastado = cliente.pedidos.reduce((sum, p) => sum + (p.totalFinal || 0), 0);
                const ultimoPedido = cliente.pedidos[cliente.pedidos.length - 1];
                
                const card = document.createElement('div');
                card.className = 'cliente-card';
                card.onclick = () => mostrarHistorialCliente(cliente);
                
                card.innerHTML = `
                    <div class="cliente-nombre">${cliente.nombre}</div>
                    <div class="cliente-info">üì± ${cliente.celular}</div>
                    <div class="cliente-info">üìç ${cliente.comuna}</div>
                    <div class="cliente-info">üí∞ Total gastado: $${totalGastado.toLocaleString('es-CL')}</div>
                    <div class="cliente-info">üìÖ √öltimo pedido: ${new Date(ultimoPedido.fechaPedido).toLocaleDateString()}</div>
                    <span class="badge-pedidos">${cliente.pedidos.length} pedido${cliente.pedidos.length !== 1 ? 's' : ''}</span>
                `;
                
                listaClientes.appendChild(card);
            });
        }
        
        function mostrarHistorialCliente(cliente) {
            const modal = document.getElementById('modalDetalle');
            document.getElementById('detalleTitulo').textContent = `Historial de ${cliente.nombre}`;
            
            let pedidosHTML = cliente.pedidos.map(pedido => {
                const estadoClass = `estado-${pedido.estado}`;
                const estadoTexto = {
                    recibido: 'Pedido Recibido',
                    fabricacion: 'En Fabricaci√≥n',
                    revision: 'En Revisi√≥n',
                    listo: 'Listo para Entrega',
                    entregado: 'Entregado'
                }[pedido.estado];
                
                return `
                    <div class="card" style="margin-bottom: 15px;">
                        <div class="card-contenido">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="font-size: 16px;">Pedido #${pedido.id}</strong>
                                <span class="estado-badge ${estadoClass}">${estadoTexto}</span>
                            </div>
                            <div class="card-info">üìÖ ${new Date(pedido.fechaPedido).toLocaleDateString()}</div>
                            <div class="card-info">üí∞ Total: $${(pedido.totalFinal || 0).toLocaleString('es-CL')}</div>
                            ${pedido.figuras && pedido.figuras.length > 0 ? `
                                <div class="card-info">üì¶ ${pedido.figuras.length} figura${pedido.figuras.length !== 1 ? 's' : ''}</div>
                            ` : ''}
                            <button class="btn btn-ver" style="width: 100%; margin-top: 10px;" onclick="verDetalle(${pedido.id})">Ver Detalle</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('detalleContenido').innerHTML = `
                <div class="seccion-titulo">Informaci√≥n del Cliente</div>
                <div class="card-info"><strong>Nombre:</strong> ${cliente.nombre}</div>
                <div class="card-info"><strong>Celular:</strong> ${cliente.celular}</div>
                <div class="card-info"><strong>Email:</strong> ${cliente.email}</div>
                <div class="card-info"><strong>Comuna:</strong> ${cliente.comuna}</div>
                
                <div class="seccion-titulo">Historial de Pedidos (${cliente.pedidos.length})</div>
                ${pedidosHTML}
            `;
            
            // Ocultar link de seguimiento
            document.querySelector('.link-seguimiento').style.display = 'none';
            
            modal.classList.add('activo');
        }
        
        function renderizarDashboard() {
            const totalPedidos = pedidos.length;
            const pendientes = pedidos.filter(p => p.estado !== 'entregado').length;
            const completados = pedidos.filter(p => p.estado === 'entregado').length;
            
            // Contar clientes √∫nicos
            const clientesUnicos = new Set();
            pedidos.forEach(p => {
                const celular = p.celular || p.telefono;
                if (celular) clientesUnicos.add(celular);
            });
            
            const totalIngresos = pedidos
                .filter(p => p.estadoPago === 'Pagado')
                .reduce((sum, p) => sum + (p.totalFinal || 0), 0);
            
            const porPagar = pedidos
                .filter(p => p.estadoPago === 'Por Pagar')
                .reduce((sum, p) => sum + (p.totalFinal || 0), 0);
            
            document.getElementById('dashboardStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icono">üì¶</div>
                    <div class="stat-label">Total de Pedidos</div>
                    <div class="stat-numero">${totalPedidos}</div>
                </div>
                
                <div class="stat-card pendientes">
                    <div class="stat-icono">‚è≥</div>
                    <div class="stat-label">Pedidos Pendientes</div>
                    <div class="stat-numero">${pendientes}</div>
                </div>
                
                <div class="stat-card completados">
                    <div class="stat-icono">‚úÖ</div>
                    <div class="stat-label">Pedidos Completados</div>
                    <div class="stat-numero">${completados}</div>
                </div>
                
                <div class="stat-card clientes">
                    <div class="stat-icono">üë•</div>
                    <div class="stat-label">Clientes</div>
                    <div class="stat-numero">${clientesUnicos.size}</div>
                </div>
                
                <div class="stat-card" style="border-left-color: #10b981;">
                    <div class="stat-icono">üí∞</div>
                    <div class="stat-label">Ingresos (Pagados)</div>
                    <div class="stat-numero" style="font-size: 24px;">$${totalIngresos.toLocaleString('es-CL')}</div>
                </div>
                
                <div class="stat-card" style="border-left-color: #f59e0b;">
                    <div class="stat-icono">‚è∞</div>
                    <div class="stat-label">Por Cobrar</div>
                    <div class="stat-numero" style="font-size: 24px;">$${porPagar.toLocaleString('es-CL')}</div>
                </div>
            `;
            
            // Gr√°fico simple de pedidos por estado
            renderizarGraficoPedidos();
        }
        
        function renderizarGraficoPedidos() {
            const estados = {
                recibido: pedidos.filter(p => p.estado === 'recibido').length,
                fabricacion: pedidos.filter(p => p.estado === 'fabricacion').length,
                revision: pedidos.filter(p => p.estado === 'revision').length,
                listo: pedidos.filter(p => p.estado === 'listo').length,
                entregado: pedidos.filter(p => p.estado === 'entregado').length
            };
            
            const total = pedidos.length || 1;
            
            document.getElementById('graficoPedidos').innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="color: #7c3aed; margin-bottom: 20px;">Estado de Pedidos</h3>
                    ${Object.entries(estados).map(([estado, cantidad]) => {
                        const porcentaje = (cantidad / total) * 100;
                        const colores = {
                            recibido: '#3b82f6',
                            fabricacion: '#f59e0b',
                            revision: '#f97316',
                            listo: '#10b981',
                            entregado: '#6b7280'
                        };
                        const nombres = {
                            recibido: 'Recibidos',
                            fabricacion: 'En Fabricaci√≥n',
                            revision: 'En Revisi√≥n',
                            listo: 'Listos',
                            entregado: 'Entregados'
                        };
                        
                        return `
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="font-weight: 600; color: #374151;">${nombres[estado]}</span>
                                    <span style="font-weight: 600; color: #6b7280;">${cantidad}</span>
                                </div>
                                <div style="width: 100%; height: 12px; background: #f3f4f6; border-radius: 6px; overflow: hidden;">
                                    <div style="width: ${porcentaje}%; height: 100%; background: ${colores[estado]}; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function generarLinkSeguimiento(pedidoId) {
            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}?pedido=${pedidoId}`;
        }
        
        function copiarLinkSeguimiento() {
            const input = document.getElementById('linkSeguimiento');
            input.select();
            document.execCommand('copy');
            
            const btn = event.target;
            const textoOriginal = btn.textContent;
            btn.textContent = '‚úÖ ¬°Copiado!';
            setTimeout(() => {
                btn.textContent = textoOriginal;
            }, 2000);
        }
        
        function mostrarSeguimientoPublico(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (!pedido) {
                document.getElementById('contenidoSeguimiento').innerHTML = `
                    <div class="vacio">
                        <div class="vacio-icono">‚ùå</div>
                        <p>Pedido no encontrado</p>
                    </div>
                `;
                document.getElementById('paginaSeguimiento').classList.add('activo');
                document.querySelector('.header').style.display = 'none';
                document.querySelector('.container').style.display = 'none';
                return;
            }
            
            const estadoTexto = {
                recibido: 'Pedido Recibido',
                fabricacion: 'En Fabricaci√≥n',
                revision: 'En Revisi√≥n',
                listo: 'Listo para Entrega',
                entregado: 'Entregado'
            }[pedido.estado];
            
            let timelineHTML = pedido.timeline.map((item, index) => {
                const esUltimo = index === pedido.timeline.length - 1;
                return `
                    <div class="timeline-item">
                        <div class="timeline-punto ${item.completado ? 'completado' : 'pendiente'}">
                            ${item.completado ? '‚úì' : (index + 1)}
                        </div>
                        <div class="timeline-contenido">
                            <div class="timeline-etapa ${item.completado ? 'completado' : 'pendiente'}">
                                ${item.etapa}
                            </div>
                            ${item.completado && item.fecha ? `
                                <div class="timeline-fecha">
                                    ${new Date(item.fecha).toLocaleDateString()} a las ${new Date(item.fecha).toLocaleTimeString()}
                                </div>
                            ` : '<div class="timeline-fecha">Pendiente</div>'}
                        </div>
                    </div>
                    ${!esUltimo ? `<div class="timeline-linea ${item.completado ? 'completado' : ''}"></div>` : ''}
                `;
            }).join('');
            
            document.getElementById('contenidoSeguimiento').innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #1f2937; margin-bottom: 10px;">Pedido #${pedido.id}</h2>
                    <div style="display: inline-block; padding: 10px 20px; background: #f3f4f6; border-radius: 20px; font-weight: 600; color: #7c3aed;">
                        ${estadoTexto}
                    </div>
                </div>
                
                <div style="background: #f9fafb; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                    <h3 style="color: #374151; margin-bottom: 15px; font-size: 18px;">üìã Progreso del Pedido</h3>
                    <div class="timeline">
                        ${timelineHTML}
                    </div>
                </div>
                
                ${pedido.figuras && pedido.figuras.length > 0 ? `
                    <div style="background: #f9fafb; padding: 20px; border-radius: 10px;">
                        <h3 style="color: #374151; margin-bottom: 15px; font-size: 18px;">üé® Detalles de tu Pedido</h3>
                        ${pedido.figuras.map(fig => `
                            <div style="padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-weight: 600; color: #1f2937;">${fig.nombre}</div>
                                <div style="font-size: 13px; color: #6b7280; margin-top: 5px;">
                                    ${fig.tamanoFinal || fig.tamano} ‚Ä¢ ${fig.materialFinal || fig.material} ‚Ä¢ Cantidad: ${fig.cantidad}
                                </div>
                            </div>
                        `).join('')}
                        
                        <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #7c3aed;">
                            <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; color: #7c3aed;">
                                <span>Total:</span>
                                <span>$${pedido.totalFinal.toLocaleString('es-CL')}</span>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${pedido.infoEnvio ? `
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #10b981;">
                        <h3 style="color: #166534; margin: 0 0 15px 0; font-size: 18px;">üì¶ Informaci√≥n de Env√≠o</h3>
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <strong>N√∫mero de Seguimiento:</strong><br>
                                <span style="color: #7c3aed; font-size: 18px; font-weight: 600;">${pedido.infoEnvio.numeroSeguimiento}</span>
                            </div>
                            <div style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <strong>Fecha de Env√≠o:</strong> ${new Date(pedido.infoEnvio.fechaEnvio).toLocaleDateString('es-CL')}
                            </div>
                            <div style="padding: 8px 0; ${pedido.infoEnvio.valorEnvio > 0 ? 'border-bottom: 1px solid #e5e7eb;' : ''}">
                                <strong>Empresa:</strong> ${pedido.infoEnvio.empresaEnvio}
                            </div>
                            ${pedido.infoEnvio.valorEnvio > 0 ? `
                                <div style="padding: 8px 0;">
                                    <strong>Valor del Env√≠o:</strong> <span style="color: #10b981; font-weight: 600;">${pedido.infoEnvio.valorEnvio.toLocaleString('es-CL')}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}
                
                <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb; color: #6b7280;">
                    <p>¬øTienes dudas sobre tu pedido?</p>
                    <p style="margin-top: 5px;">Cont√°ctanos: <strong>${pedido.celular || 'Ver contacto en Instagram'}</strong></p>
                </div>
            `;
            
            document.getElementById('paginaSeguimiento').classList.add('activo');
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.container').style.display = 'none';
        }

        // Funciones de conexi√≥n con Google Sheets
        function mostrarCargando() {
            const lista = document.getElementById('listaPedidos');
            lista.innerHTML = `
                <div class="card">
                    <div class="vacio">
                        <div class="vacio-icono">‚è≥</div>
                        <p>Cargando pedidos desde la nube...</p>
                    </div>
                </div>
            `;
        }
        
        function actualizarIndicadorNube(conectado, mensaje) {
            const indicador = document.getElementById('indicadorNube');
            const texto = document.getElementById('textoIndicador');
            
            if (conectado) {
                indicador.className = 'indicador-nube conectado';
                texto.textContent = mensaje || 'Conectado a Google Sheets';
            } else {
                indicador.className = 'indicador-nube desconectado';
                texto.textContent = mensaje || 'Sin conexi√≥n - Modo local';
            }
        }
        
        async function sincronizarManual() {
            actualizarIndicadorNube(true, 'Sincronizando...');
            await cargarPedidosDesdeNube();
            setTimeout(() => {
                actualizarIndicadorNube(true, 'Sincronizado ‚úì');
                setTimeout(() => {
                    actualizarIndicadorNube(true, 'Conectado a Google Sheets');
                }, 2000);
            }, 500);
        }
        
        async function cargarPedidosDesdeNube() {
            try {
                cargando = true;
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=obtenerPedidos');
                const data = await response.json();
                
                if (data.status === 'success') {
                    pedidos = data.pedidos || [];
                    actualizarIndicadorNube(true, 'Conectado a Google Sheets');
                    console.log('‚úÖ Pedidos cargados desde Google Sheets:', pedidos.length);
                } else {
                    console.error('‚ùå Error al cargar pedidos:', data.message);
                    actualizarIndicadorNube(false, 'Error de conexi√≥n');
                    cargarPedidosLocal();
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                actualizarIndicadorNube(false, 'Sin conexi√≥n - Modo local');
                cargarPedidosLocal();
            } finally {
                cargando = false;
                renderizarPedidos();
            }
        }
        
        function cargarPedidosLocal() {
            const guardado = localStorage.getItem('pedidosEmporioHagrid');
            if (guardado) {
                pedidos = JSON.parse(guardado);
                console.log('üì¶ Pedidos cargados desde localStorage (respaldo)');
            }
        }
        
        async function guardarPedidoEnNube(pedido) {
            try {
                // Guardar tambi√©n en localStorage como respaldo
                localStorage.setItem('pedidosEmporioHagrid', JSON.stringify(pedidos));
                
                const formData = new FormData();
                formData.append('action', 'guardarPedido');
                formData.append('pedido', JSON.stringify(pedido));
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    console.log('‚úÖ Pedido guardado en Google Sheets');
                    actualizarIndicadorNube(true, 'Guardado en la nube ‚úì');
                    setTimeout(() => {
                        actualizarIndicadorNube(true, 'Conectado a Google Sheets');
                    }, 2000);
                    return true;
                } else {
                    console.error('‚ùå Error al guardar:', data.message);
                    actualizarIndicadorNube(false, 'Error al guardar');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n al guardar:', error);
                actualizarIndicadorNube(false, 'Sin conexi√≥n');
                return false;
            }
        }
        
        async function actualizarPedidoEnNube(pedido) {
            try {
                // Actualizar tambi√©n en localStorage como respaldo
                localStorage.setItem('pedidosEmporioHagrid', JSON.stringify(pedidos));
                
                const formData = new FormData();
                formData.append('action', 'actualizarPedido');
                formData.append('pedido', JSON.stringify(pedido));
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    console.log('‚úÖ Pedido actualizado en Google Sheets');
                    actualizarIndicadorNube(true, 'Actualizado ‚úì');
                    setTimeout(() => {
                        actualizarIndicadorNube(true, 'Conectado a Google Sheets');
                    }, 2000);
                    return true;
                } else {
                    console.error('‚ùå Error al actualizar:', data.message);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n al actualizar:', error);
                return false;
            }
        }
        
        async function eliminarPedidoEnNube(pedidoId) {
            try {
                // Eliminar tambi√©n de localStorage como respaldo
                localStorage.setItem('pedidosEmporioHagrid', JSON.stringify(pedidos));
                
                const formData = new FormData();
                formData.append('action', 'eliminarPedido');
                formData.append('pedidoId', pedidoId);
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    console.log('‚úÖ Pedido eliminado de Google Sheets');
                    actualizarIndicadorNube(true, 'Eliminado ‚úì');
                    setTimeout(() => {
                        actualizarIndicadorNube(true, 'Conectado a Google Sheets');
                    }, 2000);
                    return true;
                } else {
                    console.error('‚ùå Error al eliminar:', data.message);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n al eliminar:', error);
                return false;
            }
        }

        function mostrarFormulario(pedidoId = null) {
            modoEdicion = false;
            pedidoEnEdicion = null;
            
            document.getElementById('modalFormulario').classList.add('activo');
            document.getElementById('formPedido').reset();
            imagenesTemp = [];
            figurasPedido = [];
            contadorFilas = 0;
            document.getElementById('imagenesPreview').innerHTML = '';
            document.getElementById('cuerpoTablaFiguras').innerHTML = '';
            document.getElementById('descuentoPorcentaje').value = 0;
            
            // Si se proporciona un ID, cargar el pedido para editar
            if (pedidoId) {
                const pedido = pedidos.find(p => p.id === pedidoId);
                if (pedido) {
                    modoEdicion = true;
                    pedidoEnEdicion = pedido;
                    cargarPedidoEnFormulario(pedido);
                    document.querySelector('.modal-titulo').textContent = 'Editar Pedido #' + pedido.id;
                }
            } else {
                document.querySelector('.modal-titulo').textContent = 'Nuevo Pedido';
                agregarFilaFigura(); // Agregar primera fila autom√°ticamente solo en modo nuevo
            }
            
            calcularTotales();
        }
        
        function cargarPedidoEnFormulario(pedido) {
            // Cargar datos del cliente
            document.getElementById('nombre').value = pedido.nombre || '';
            document.getElementById('apellido').value = pedido.apellido || '';
            document.getElementById('celular').value = pedido.celular || '';
            document.getElementById('instagram').value = pedido.instagram || '';
            document.getElementById('email').value = pedido.email || '';
            document.getElementById('direccion').value = pedido.direccion || '';
            document.getElementById('comuna').value = pedido.comuna || '';
            document.getElementById('ubicacion').value = pedido.ubicacion || '';
            document.getElementById('estadoPago').value = pedido.estadoPago || '';
            document.getElementById('observaciones').value = pedido.observaciones || '';
            document.getElementById('descuentoPorcentaje').value = pedido.descuentoPorcentaje || 0;
            
            // Cargar im√°genes
            if (pedido.imagenes && pedido.imagenes.length > 0) {
                imagenesTemp = [...pedido.imagenes];
                renderizarPreviewImagenes();
            }
            
            // Cargar figuras
            if (pedido.figuras && pedido.figuras.length > 0) {
                pedido.figuras.forEach(figura => {
                    agregarFilaFigura();
                    const filaId = contadorFilas;
                    
                    // Llenar los datos de la fila
                    const fila = document.getElementById(`fila-${filaId}`);
                    if (fila) {
                        const inputs = fila.querySelectorAll('input, select');
                        inputs.forEach(input => {
                            const campo = input.dataset.campo;
                            if (campo === 'nombre') input.value = figura.nombre || '';
                            else if (campo === 'tamano') {
                                if (figura.tamano === 'Personalizado' || (!['28mm', '32mm'].includes(figura.tamano))) {
                                    input.value = 'Personalizado';
                                    mostrarCampoPersonalizado(filaId, 'tamano');
                                    const inputPersonalizado = document.getElementById(`input-tamano-${filaId}`);
                                    if (inputPersonalizado) {
                                        inputPersonalizado.value = figura.tamanoFinal || figura.tamano || '';
                                    }
                                } else {
                                    input.value = figura.tamano;
                                }
                            }
                            else if (campo === 'material') {
                                if (figura.material === 'Otro' || (!['Resina', 'PLA'].includes(figura.material))) {
                                    input.value = 'Otro';
                                    mostrarCampoPersonalizado(filaId, 'material');
                                    const inputPersonalizado = document.getElementById(`input-material-${filaId}`);
                                    if (inputPersonalizado) {
                                        inputPersonalizado.value = figura.materialFinal || figura.material || '';
                                    }
                                } else {
                                    input.value = figura.material;
                                }
                            }
                            else if (campo === 'cantidad') input.value = figura.cantidad || 1;
                            else if (campo === 'valorUnitario') input.value = figura.valorUnitario || 0;
                        });
                        
                        // Mantener el estado de fabricada si existe
                        if (figura.fabricada !== undefined) {
                            const figuraActual = pedidoEnEdicion.figuras[pedido.figuras.indexOf(figura)];
                            if (figuraActual) {
                                figuraActual.fabricada = figura.fabricada;
                            }
                        }
                    }
                });
            } else {
                // Si no hay figuras, agregar una fila vac√≠a
                agregarFilaFigura();
            }
            
            calcularTotales();
        }

        function cerrarFormulario() {
            document.getElementById('modalFormulario').classList.remove('activo');
        }

        function procesarImagenes(event) {
            const archivos = event.target.files;
            
            for (let i = 0; i < archivos.length; i++) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagenesTemp.push(e.target.result);
                    renderizarPreviewImagenes();
                };
                reader.readAsDataURL(archivos[i]);
            }
        }

        function renderizarPreviewImagenes() {
            const preview = document.getElementById('imagenesPreview');
            preview.innerHTML = '';
            
            imagenesTemp.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'imagen-preview';
                div.innerHTML = `
                    <img src="${img}">
                    <button type="button" class="imagen-preview-eliminar" onclick="eliminarImagenTemp(${index})">√ó</button>
                `;
                preview.appendChild(div);
            });
        }

        function eliminarImagenTemp(index) {
            imagenesTemp.splice(index, 1);
            renderizarPreviewImagenes();
        }
        
        function agregarFilaFigura() {
            contadorFilas++;
            const tbody = document.getElementById('cuerpoTablaFiguras');
            const fila = document.createElement('tr');
            fila.id = `fila-${contadorFilas}`;
            fila.innerHTML = `
                <td>
                    <input type="text" class="form-input" placeholder="Nombre de la figura" 
                           data-fila="${contadorFilas}" data-campo="nombre">
                </td>
                <td>
                    <select class="form-input" data-fila="${contadorFilas}" data-campo="tamano" 
                            id="select-tamano-${contadorFilas}" onchange="mostrarCampoPersonalizado(${contadorFilas}, 'tamano')">
                        <option value="28mm">28mm</option>
                        <option value="32mm">32mm</option>
                        <option value="Personalizado">Personalizado</option>
                    </select>
                    <input type="text" class="form-input" placeholder="Especificar tama√±o" 
                           style="display: none; margin-top: 5px;"
                           data-fila="${contadorFilas}" data-campo="tamanoPersonalizado" 
                           id="input-tamano-${contadorFilas}">
                </td>
                <td>
                    <select class="form-input" data-fila="${contadorFilas}" data-campo="material"
                            id="select-material-${contadorFilas}" onchange="mostrarCampoPersonalizado(${contadorFilas}, 'material')">
                        <option value="Resina">Resina</option>
                        <option value="PLA">PLA</option>
                        <option value="Otro">Otro</option>
                    </select>
                    <input type="text" class="form-input" placeholder="Especificar material" 
                           style="display: none; margin-top: 5px;"
                           data-fila="${contadorFilas}" data-campo="materialPersonalizado" 
                           id="input-material-${contadorFilas}">
                </td>
                <td>
                    <input type="number" class="form-input input-pequeno" value="1" min="1" 
                           data-fila="${contadorFilas}" data-campo="cantidad" onchange="calcularTotales()">
                </td>
                <td>
                    <input type="number" class="form-input input-pequeno" value="0" min="0" 
                           data-fila="${contadorFilas}" data-campo="valorUnitario" onchange="calcularTotales()">
                </td>
                <td>
                    <strong id="total-${contadorFilas}">$0</strong>
                </td>
                <td style="text-align: center;">
                    <button type="button" class="btn-eliminar-fila" onclick="eliminarFilaFigura(${contadorFilas})">‚úï</button>
                </td>
            `;
            tbody.appendChild(fila);
        }
        
        function mostrarCampoPersonalizado(idFila, tipo) {
            const selectElement = document.getElementById(`select-${tipo}-${idFila}`);
            const inputElement = document.getElementById(`input-${tipo}-${idFila}`);
            
            if (tipo === 'tamano') {
                if (selectElement.value === 'Personalizado') {
                    inputElement.style.display = 'block';
                    inputElement.focus();
                } else {
                    inputElement.style.display = 'none';
                    inputElement.value = '';
                }
            } else if (tipo === 'material') {
                if (selectElement.value === 'Otro') {
                    inputElement.style.display = 'block';
                    inputElement.focus();
                } else {
                    inputElement.style.display = 'none';
                    inputElement.value = '';
                }
            }
        }
        
        function eliminarFilaFigura(idFila) {
            const fila = document.getElementById(`fila-${idFila}`);
            if (fila) {
                fila.remove();
                calcularTotales();
            }
        }
        
        function calcularTotales() {
            let subtotal = 0;
            const tbody = document.getElementById('cuerpoTablaFiguras');
            const filas = tbody.getElementsByTagName('tr');
            
            for (let fila of filas) {
                const inputs = fila.querySelectorAll('input, select');
                let cantidad = 1;
                let valorUnitario = 0;
                let idFila = null;
                
                inputs.forEach(input => {
                    const campo = input.dataset.campo;
                    idFila = input.dataset.fila;
                    
                    if (campo === 'cantidad') {
                        cantidad = parseInt(input.value) || 1;
                    } else if (campo === 'valorUnitario') {
                        valorUnitario = parseFloat(input.value) || 0;
                    }
                });
                
                const totalFila = cantidad * valorUnitario;
                subtotal += totalFila;
                
                if (idFila) {
                    const totalElement = document.getElementById(`total-${idFila}`);
                    if (totalElement) {
                        totalElement.textContent = `$${totalFila.toLocaleString('es-CL')}`;
                    }
                }
            }
            
            const descuentoPorcentaje = parseFloat(document.getElementById('descuentoPorcentaje').value) || 0;
            const descuento = (subtotal * descuentoPorcentaje) / 100;
            const totalFinal = subtotal - descuento;
            
            document.getElementById('subtotalTexto').textContent = `$${subtotal.toLocaleString('es-CL')}`;
            document.getElementById('descuentoTexto').textContent = `-$${descuento.toLocaleString('es-CL')}`;
            document.getElementById('totalFinalTexto').textContent = `$${totalFinal.toLocaleString('es-CL')}`;
        }
        
        function obtenerFigurasDeLaTabla() {
            const figuras = [];
            const tbody = document.getElementById('cuerpoTablaFiguras');
            const filas = tbody.getElementsByTagName('tr');
            
            for (let fila of filas) {
                const inputs = fila.querySelectorAll('input, select');
                let figura = {
                    nombre: '',
                    tamano: '',
                    tamanoPersonalizado: '',
                    material: '',
                    materialPersonalizado: '',
                    cantidad: 1,
                    valorUnitario: 0,
                    fabricada: false
                };
                
                inputs.forEach(input => {
                    const campo = input.dataset.campo;
                    if (campo === 'nombre') figura.nombre = input.value;
                    else if (campo === 'tamano') figura.tamano = input.value;
                    else if (campo === 'tamanoPersonalizado') figura.tamanoPersonalizado = input.value;
                    else if (campo === 'material') figura.material = input.value;
                    else if (campo === 'materialPersonalizado') figura.materialPersonalizado = input.value;
                    else if (campo === 'cantidad') figura.cantidad = parseInt(input.value) || 1;
                    else if (campo === 'valorUnitario') figura.valorUnitario = parseFloat(input.value) || 0;
                });
                
                // Si el tama√±o es personalizado, usar el valor personalizado
                if (figura.tamano === 'Personalizado' && figura.tamanoPersonalizado) {
                    figura.tamanoFinal = figura.tamanoPersonalizado;
                } else {
                    figura.tamanoFinal = figura.tamano;
                }
                
                // Si el material es otro, usar el valor personalizado
                if (figura.material === 'Otro' && figura.materialPersonalizado) {
                    figura.materialFinal = figura.materialPersonalizado;
                } else {
                    figura.materialFinal = figura.material;
                }
                
                figura.valorTotal = figura.cantidad * figura.valorUnitario;
                
                // Si estamos editando, mantener el estado de fabricada
                if (modoEdicion && pedidoEnEdicion && pedidoEnEdicion.figuras) {
                    const figuraOriginal = pedidoEnEdicion.figuras.find(f => f.nombre === figura.nombre);
                    if (figuraOriginal && figuraOriginal.fabricada !== undefined) {
                        figura.fabricada = figuraOriginal.fabricada;
                    }
                    // Mantener tambi√©n los hitos
                    if (figuraOriginal && figuraOriginal.hitos) {
                        figura.hitos = figuraOriginal.hitos;
                    }
                }
                
                if (figura.nombre) { // Solo agregar si tiene nombre
                    figuras.push(figura);
                }
            }
            
            return figuras;
        }

        function guardarPedido(event) {
            event.preventDefault();
            
            const figuras = obtenerFigurasDeLaTabla();
            
            if (figuras.length === 0) {
                alert('Debes agregar al menos una figura al pedido');
                return;
            }
            
            const fechaActual = new Date().toISOString();
            const nombre = document.getElementById('nombre').value;
            const apellido = document.getElementById('apellido').value;
            
            const subtotal = figuras.reduce((sum, fig) => sum + fig.valorTotal, 0);
            const descuentoPorcentaje = parseFloat(document.getElementById('descuentoPorcentaje').value) || 0;
            const descuento = (subtotal * descuentoPorcentaje) / 100;
            const totalFinal = subtotal - descuento;
            
            if (modoEdicion && pedidoEnEdicion) {
                // MODO EDICI√ìN: Actualizar pedido existente
                const pedidoActualizado = {
                    ...pedidoEnEdicion,
                    nombre: nombre,
                    apellido: apellido,
                    nombreCompleto: `${nombre} ${apellido}`,
                    celular: document.getElementById('celular').value,
                    instagram: document.getElementById('instagram').value,
                    email: document.getElementById('email').value,
                    direccion: document.getElementById('direccion').value,
                    comuna: document.getElementById('comuna').value,
                    ubicacion: document.getElementById('ubicacion').value,
                    estadoPago: document.getElementById('estadoPago').value,
                    figuras: figuras,
                    subtotal: subtotal,
                    descuentoPorcentaje: descuentoPorcentaje,
                    descuento: descuento,
                    totalFinal: totalFinal,
                    observaciones: document.getElementById('observaciones').value,
                    imagenes: [...imagenesTemp],
                    fechaModificacion: fechaActual
                };
                
                // Actualizar en el array
                const index = pedidos.findIndex(p => p.id === pedidoEnEdicion.id);
                if (index !== -1) {
                    pedidos[index] = pedidoActualizado;
                }
                
                // Actualizar en la nube
                actualizarPedidoEnNube(pedidoActualizado).then(success => {
                    if (success) {
                        alert('‚úÖ Pedido actualizado exitosamente');
                    } else {
                        alert('‚ö†Ô∏è Pedido actualizado localmente. Verifica tu conexi√≥n a internet.');
                    }
                    cerrarFormulario();
                    renderizarPedidos();
                });
                
            } else {
                // MODO NUEVO: Crear pedido nuevo
                const nuevoPedido = {
                    id: Date.now(),
                    nombre: nombre,
                    apellido: apellido,
                    nombreCompleto: `${nombre} ${apellido}`,
                    celular: document.getElementById('celular').value,
                    instagram: document.getElementById('instagram').value,
                    email: document.getElementById('email').value,
                    direccion: document.getElementById('direccion').value,
                    comuna: document.getElementById('comuna').value,
                    ubicacion: document.getElementById('ubicacion').value,
                    estadoPago: document.getElementById('estadoPago').value,
                    figuras: figuras,
                    subtotal: subtotal,
                    descuentoPorcentaje: descuentoPorcentaje,
                    descuento: descuento,
                    totalFinal: totalFinal,
                    observaciones: document.getElementById('observaciones').value,
                    imagenes: [...imagenesTemp],
                    fechaPedido: fechaActual,
                    estado: 'recibido',
                    timeline: [
                        { etapa: 'Pedido Recibido', completado: true, fecha: fechaActual },
                        { etapa: 'En Fabricaci√≥n', completado: false, fecha: null },
                        { etapa: 'En Revisi√≥n', completado: false, fecha: null },
                        { etapa: 'Listo para Entrega', completado: false, fecha: null },
                        { etapa: 'Entregado', completado: false, fecha: null }
                    ]
                };
                
                pedidos.push(nuevoPedido);
                
                // Guardar en la nube
                guardarPedidoEnNube(nuevoPedido).then(success => {
                    if (success) {
                        alert('‚úÖ Pedido guardado exitosamente en Google Sheets');
                    } else {
                        alert('‚ö†Ô∏è Pedido guardado localmente. Verifica tu conexi√≥n a internet.');
                    }
                    cerrarFormulario();
                    renderizarPedidos();
                });
            }
        }

        function filtrarPedidos(filtro) {
            filtroActual = filtro;
            
            // Actualizar botones
            document.querySelectorAll('.filtro-btn').forEach(btn => {
                btn.classList.remove('activo');
            });
            event.target.classList.add('activo');
            
            // Si hay b√∫squeda activa, re-aplicar
            if (terminoBusqueda) {
                buscarPedidos(terminoBusqueda);
            } else {
                renderizarPedidos();
            }
        }

        function renderizarPedidos() {
            const lista = document.getElementById('listaPedidos');
            
            // Determinar qu√© pedidos mostrar
            let pedidosAMostrar = terminoBusqueda ? pedidosFiltrados : pedidos;
            
            // Aplicar filtro de estado si no hay b√∫squeda activa
            if (!terminoBusqueda && filtroActual !== 'todos') {
                pedidosAMostrar = pedidos.filter(p => p.estado === filtroActual);
            }
            
            if (pedidosAMostrar.length === 0) {
                if (terminoBusqueda) {
                    lista.innerHTML = `
                        <div class="card">
                            <div class="vacio">
                                <div class="vacio-icono">üîç</div>
                                <p>No se encontraron pedidos con "<strong>${terminoBusqueda}</strong>"</p>
                                <button class="btn btn-ver" onclick="limpiarBusqueda()" style="margin-top: 15px;">Ver todos los pedidos</button>
                            </div>
                        </div>
                    `;
                } else {
                    lista.innerHTML = `
                        <div class="card">
                            <div class="vacio">
                                <div class="vacio-icono">üì¶</div>
                                <p>No hay pedidos ${filtroActual !== 'todos' ? 'en este estado' : 'registrados'}</p>
                            </div>
                        </div>
                    `;
                }
                return;
            }
            
            lista.innerHTML = '';
            
            pedidosAMostrar.forEach(pedido => {
                const card = document.createElement('div');
                card.className = 'card';
                
                const estadoClass = `estado-${pedido.estado}`;
                const estadoTexto = {
                    recibido: 'Pedido Recibido',
                    fabricacion: 'En Fabricaci√≥n',
                    revision: 'En Revisi√≥n',
                    listo: 'Listo para Entrega',
                    entregado: 'Entregado'
                }[pedido.estado];
                
                const nombreCliente = pedido.nombreCompleto || pedido.nombreCliente || (pedido.nombre + ' ' + pedido.apellido);
                const nombreFigura = pedido.figuras && pedido.figuras.length > 0 ? pedido.figuras[0].nombre : (pedido.nombreFigura || 'Pedido');
                
                // Resaltar t√©rminos de b√∫squeda
                const nombreClienteHTML = terminoBusqueda ? resaltarTexto(nombreCliente, terminoBusqueda) : nombreCliente;
                const nombreFiguraHTML = terminoBusqueda ? resaltarTexto(nombreFigura, terminoBusqueda) : nombreFigura;
                const comunaHTML = terminoBusqueda ? resaltarTexto(pedido.comuna || 'N/A', terminoBusqueda) : (pedido.comuna || 'N/A');
                const pedidoIdHTML = terminoBusqueda ? resaltarTexto('#' + pedido.id, terminoBusqueda) : '#' + pedido.id;
                
                card.innerHTML = `
                    <div class="card-imagen">
                        ${pedido.imagenes && pedido.imagenes.length > 0 
                            ? `<img src="${pedido.imagenes[0]}">`
                            : 'üé®'
                        }
                    </div>
                    <div class="card-contenido">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-size: 12px; color: #9ca3af; font-weight: 600;">${pedidoIdHTML}</span>
                            <span class="estado-badge ${estadoClass}">${estadoTexto}</span>
                        </div>
                        <div class="card-titulo">${nombreFiguraHTML}</div>
                        <div class="card-info"><strong>Cliente:</strong> ${nombreClienteHTML}</div>
                        <div class="card-info"><strong>Total:</strong> ${(pedido.totalFinal || pedido.precio || 0).toLocaleString('es-CL')}</div>
                        <div class="card-info"><strong>Comuna:</strong> ${comunaHTML}</div>
                        <div class="card-info"><strong>Pedido:</strong> ${new Date(pedido.fechaPedido).toLocaleDateString()}</div>
                        
                        ${pedido.estado !== 'entregado' ? `
                            <div class="form-grupo">
                                <select class="form-input" onchange="cambiarEstado(${pedido.id}, this.value)">
                                    <option value="recibido" ${pedido.estado === 'recibido' ? 'selected' : ''}>Recibido</option>
                                    <option value="fabricacion" ${pedido.estado === 'fabricacion' ? 'selected' : ''}>En Fabricaci√≥n</option>
                                    <option value="revision" ${pedido.estado === 'revision' ? 'selected' : ''}>En Revisi√≥n</option>
                                    <option value="listo" ${pedido.estado === 'listo' ? 'selected' : ''}>Listo para Entrega</option>
                                    <option value="entregado" ${pedido.estado === 'entregado' ? 'selected' : ''}>Entregado</option>
                                </select>
                            </div>
                        ` : ''}
                        
                        <div class="card-acciones">
                            <button class="btn btn-ver" onclick="verDetalle(${pedido.id})">Ver Detalle</button>
                            <button class="btn btn-link" onclick="mostrarFormulario(${pedido.id})" style="background: #f59e0b;">‚úèÔ∏è Editar</button>
                            <button class="btn btn-imprimir" onclick="imprimirPedidoDirecto(${pedido.id})">üñ®Ô∏è</button>
                            <button class="btn btn-link" onclick="imprimirEtiquetaDirecta(${pedido.id})" style="background: #3498db; flex: 0 0 50px;">üì¶</button>
                            <button class="btn btn-eliminar" onclick="eliminarPedido(${pedido.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                
                lista.appendChild(card);
            });
        }

        function cambiarEstado(id, nuevoEstado) {
            const fechaActual = new Date().toISOString();
            
            pedidos = pedidos.map(p => {
                if (p.id === id) {
                    const timeline = [...p.timeline];
                    
                    if (nuevoEstado === 'fabricacion') {
                        timeline[1] = { ...timeline[1], completado: true, fecha: fechaActual };
                    } else if (nuevoEstado === 'revision') {
                        timeline[1] = { ...timeline[1], completado: true, fecha: timeline[1].fecha || fechaActual };
                        timeline[2] = { ...timeline[2], completado: true, fecha: fechaActual };
                    } else if (nuevoEstado === 'listo') {
                        timeline[1] = { ...timeline[1], completado: true, fecha: timeline[1].fecha || fechaActual };
                        timeline[2] = { ...timeline[2], completado: true, fecha: timeline[2].fecha || fechaActual };
                        timeline[3] = { ...timeline[3], completado: true, fecha: fechaActual };
                    } else if (nuevoEstado === 'entregado') {
                        timeline[1] = { ...timeline[1], completado: true, fecha: timeline[1].fecha || fechaActual };
                        timeline[2] = { ...timeline[2], completado: true, fecha: timeline[2].fecha || fechaActual };
                        timeline[3] = { ...timeline[3], completado: true, fecha: timeline[3].fecha || fechaActual };
                        timeline[4] = { ...timeline[4], completado: true, fecha: fechaActual };
                    }
                    
                    const pedidoActualizado = { ...p, estado: nuevoEstado, timeline };
                    
                    // Actualizar en la nube
                    actualizarPedidoEnNube(pedidoActualizado);
                    
                    return pedidoActualizado;
                }
                return p;
            });
            
            renderizarPedidos();
        }

        function eliminarPedido(id) {
            if (confirm('¬øEst√°s seguro de eliminar este pedido?')) {
                pedidos = pedidos.filter(p => p.id !== id);
                
                // Eliminar de la nube
                eliminarPedidoEnNube(id).then(success => {
                    if (success) {
                        console.log('‚úÖ Pedido eliminado de Google Sheets');
                    }
                    renderizarPedidos();
                });
            }
        }

        function verDetalle(id) {
            const pedido = pedidos.find(p => p.id === id);
            if (!pedido) return;
            
            pedidoActual = pedido;
            
            // Asegurar que todas las figuras tengan hitos inicializados
            if (pedido.figuras && pedido.figuras.length > 0) {
                pedido.figuras.forEach(fig => {
                    if (!fig.hitos) {
                        fig.hitos = {
                            laminado: false,
                            fabricado: false,
                            curado: false,
                            imprimado: false
                        };
                    }
                });
            }
            
            const titulo = pedido.figuras && pedido.figuras.length > 0 ? pedido.figuras[0].nombre : (pedido.nombreFigura || 'Pedido');
            document.getElementById('detalleTitulo').textContent = titulo;
            
            // Mostrar link de seguimiento
            document.querySelector('.link-seguimiento').style.display = 'block';
            document.getElementById('linkSeguimiento').value = generarLinkSeguimiento(pedido.id);
            
            const estadoTexto = {
                recibido: 'Pedido Recibido',
                fabricacion: 'En Fabricaci√≥n',
                revision: 'En Revisi√≥n',
                listo: 'Listo para Entrega',
                entregado: 'Entregado'
            }[pedido.estado];
            
            let imagenesHTML = '';
            if (pedido.imagenes && pedido.imagenes.length > 0) {
                imagenesHTML = `
                    <div class="seccion-titulo">Im√°genes</div>
                    <div class="imagenes-preview">
                        ${pedido.imagenes.map(img => `
                            <div class="imagen-preview">
                                <img src="${img}">
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            let timelineHTML = '';
            pedido.timeline.forEach((item, index) => {
                const esUltimo = index === pedido.timeline.length - 1;
                timelineHTML += `
                    <div class="timeline-item">
                        <div class="timeline-punto ${item.completado ? 'completado' : 'pendiente'}">
                            ${item.completado ? '‚úì' : (index + 1)}
                        </div>
                        <div class="timeline-contenido">
                            <div class="timeline-etapa ${item.completado ? 'completado' : 'pendiente'}">
                                ${item.etapa}
                            </div>
                            ${item.completado && item.fecha ? `
                                <div class="timeline-fecha">
                                    ${new Date(item.fecha).toLocaleDateString()} a las ${new Date(item.fecha).toLocaleTimeString()}
                                </div>
                            ` : '<div class="timeline-fecha">Pendiente</div>'}
                        </div>
                    </div>
                    ${!esUltimo ? `<div class="timeline-linea ${item.completado ? 'completado' : ''}"></div>` : ''}
                `;
            });
            
            const nombreCliente = pedido.nombreCompleto || pedido.nombreCliente || `${pedido.nombre || ''} ${pedido.apellido || ''}`.trim();
            
            document.getElementById('detalleContenido').innerHTML = `
                <div class="seccion-titulo">Cliente</div>
                <div class="card-info"><strong>Nombre:</strong> ${pedido.nombre || nombreCliente}</div>
                ${pedido.apellido ? `<div class="card-info"><strong>Apellido:</strong> ${pedido.apellido}</div>` : ''}
                <div class="card-info"><strong>Celular:</strong> ${pedido.celular || pedido.telefono || 'N/A'}</div>
                ${pedido.instagram ? `<div class="card-info"><strong>üì∑ Instagram:</strong> <a href="https://instagram.com/${pedido.instagram.replace('@', '')}" target="_blank" style="color: #9333ea; text-decoration: none;">${pedido.instagram}</a></div>` : ''}
                ${pedido.email ? `<div class="card-info"><strong>Email:</strong> ${pedido.email}</div>` : ''}
                <div class="card-info"><strong>Direcci√≥n:</strong> ${pedido.direccion || 'N/A'}</div>
                <div class="card-info"><strong>Comuna:</strong> ${pedido.comuna || 'N/A'}</div>
                <div class="card-info"><strong>Ubicaci√≥n:</strong> ${pedido.ubicacion || 'N/A'}</div>
                <div class="card-info"><strong>Estado de Pago:</strong> <span style="color: ${pedido.estadoPago === 'Pagado' ? '#10b981' : '#f59e0b'}; font-weight: bold;">${pedido.estadoPago || 'N/A'}</span></div>
                
                <!-- Bot√≥n de Editar en el Detalle -->
                <button class="btn btn-link" onclick="cerrarDetalle(); mostrarFormulario(${pedido.id});" style="width: 100%; margin-top: 15px; background: #f59e0b;">
                    ‚úèÔ∏è Editar este Pedido
                </button>
                
                <div class="seccion-titulo">Detalles del Pedido</div>
                ${pedido.figuras && pedido.figuras.length > 0 ? `
                    <!-- Progreso de Fabricaci√≥n -->
                    <div class="progreso-figuras">
                        <span style="font-weight: 600; color: #374151;">Progreso:</span>
                        <div class="progreso-barra">
                            <div class="progreso-relleno" style="width: ${calcularProgresoFiguras(pedido.figuras)}%"></div>
                        </div>
                        <span class="badge-progreso">${contarFabricadas(pedido.figuras)} / ${pedido.figuras.length}</span>
                    </div>
                    
                    <!-- Lista de Figuras con Checkboxes -->
                    <div style="margin-top: 15px;">
                        ${pedido.figuras.map((fig, index) => `
                            <div class="figura-item ${fig.fabricada ? 'completada' : ''}">
                                <input 
                                    type="checkbox" 
                                    class="check-fabricada" 
                                    ${fig.fabricada ? 'checked' : ''} 
                                    onchange="toggleFiguraFabricada(${pedido.id}, ${index})"
                                >
                                <div class="figura-info ${fig.fabricada ? 'figura-fabricada' : ''}">
                                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">${fig.nombre}</div>
                                    <div style="font-size: 13px; color: #6b7280;">
                                        ${fig.tamanoFinal || fig.tamano} ‚Ä¢ ${fig.materialFinal || fig.material} ‚Ä¢ Cantidad: ${fig.cantidad} ‚Ä¢ ${fig.valorTotal.toLocaleString('es-CL')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 15px; background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                            <span>Subtotal:</span>
                            <strong>${pedido.subtotal.toLocaleString('es-CL')}</strong>
                        </div>
                        ${pedido.descuentoPorcentaje > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 5px 0; color: #f59e0b;">
                                <span>Descuento (${pedido.descuentoPorcentaje}%):</span>
                                <strong>-${pedido.descuento.toLocaleString('es-CL')}</strong>
                            </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 2px solid #e5e7eb; margin-top: 5px; font-size: 18px; color: #7c3aed;">
                            <span><strong>TOTAL:</strong></span>
                            <strong>${pedido.totalFinal.toLocaleString('es-CL')}</strong>
                        </div>
                    </div>
                ` : `
                    <div class="card-info"><strong>Figura:</strong> ${pedido.nombreFigura || 'N/A'}</div>
                    ${pedido.descripcion ? `<div class="card-info"><strong>Descripci√≥n:</strong> ${pedido.descripcion}</div>` : ''}
                    ${pedido.precio ? `<div class="card-info"><strong>Precio:</strong> $${pedido.precio.toLocaleString('es-CL')}</div>` : ''}
                `}
                ${pedido.observaciones ? `
                    <div style="margin-top: 15px;">
                        <strong>Observaciones:</strong>
                        <div style="background: #f9fafb; padding: 10px; border-radius: 8px; margin-top: 5px;">
                            ${pedido.observaciones}
                        </div>
                    </div>
                ` : ''}
                <div class="card-info" style="margin-top: 10px;"><strong>Fecha del pedido:</strong> ${new Date(pedido.fechaPedido).toLocaleDateString()}</div>
                
                ${imagenesHTML}
                
                <div class="seccion-titulo">Estado Actual</div>
                ${pedido.estado !== 'entregado' ? `
                    <select class="form-input" onchange="cambiarEstadoDetalle(this.value)">
                        <option value="recibido" ${pedido.estado === 'recibido' ? 'selected' : ''}>Pedido Recibido</option>
                        <option value="fabricacion" ${pedido.estado === 'fabricacion' ? 'selected' : ''}>En Fabricaci√≥n</option>
                        <option value="revision" ${pedido.estado === 'revision' ? 'selected' : ''}>En Revisi√≥n</option>
                        <option value="listo" ${pedido.estado === 'listo' ? 'selected' : ''}>Listo para Entrega</option>
                        <option value="entregado" ${pedido.estado === 'entregado' ? 'selected' : ''}>Entregado</option>
                    </select>
                ` : `
                    <div style="background: #d1fae5; padding: 15px; border-radius: 10px; text-align: center; color: #065f46; font-weight: bold;">
                        ‚úì Pedido Entregado
                    </div>
                `}
                
                <div class="seccion-titulo">L√≠nea de Tiempo</div>
                <div class="timeline">
                    ${timelineHTML}
                </div>
            `;
            
            document.getElementById('modalDetalle').classList.add('activo');
        }

        function cambiarEstadoDetalle(nuevoEstado) {
            cambiarEstado(pedidoActual.id, nuevoEstado);
            cerrarDetalle();
        }

        function cerrarDetalle() {
            document.getElementById('modalDetalle').classList.remove('activo');
        }
        
        // Funciones para manejar el estado de fabricaci√≥n de figuras
        function toggleFiguraFabricada(pedidoId, figuraIndex) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (pedido && pedido.figuras && pedido.figuras[figuraIndex]) {
                const figura = pedido.figuras[figuraIndex];
                
                // Toggle el estado
                figura.fabricada = !figura.fabricada;
                
                // Si se marca como fabricada y tiene fecha de inicio, calcular tiempo
                if (figura.fabricada && figura.fechaInicio && !figura.fechaFin) {
                    figura.fechaFin = new Date().toISOString();
                    const tiempoMs = new Date(figura.fechaFin) - new Date(figura.fechaInicio);
                    figura.tiempoFabricacion = Math.round(tiempoMs / 60000); // Convertir a minutos
                    
                    // Detener cron√≥metro si est√° activo
                    const key = `${pedidoId}-${figuraIndex}`;
                    if (cronometrosActivos[key]) {
                        clearInterval(cronometrosActivos[key]);
                        delete cronometrosActivos[key];
                    }
                }
                
                // Si se desmarca, limpiar tiempos
                if (!figura.fabricada) {
                    figura.fechaInicio = null;
                    figura.fechaFin = null;
                    figura.tiempoFabricacion = null;
                }
                
                // Actualizar en la nube
                actualizarPedidoEnNube(pedido);
                
                // Re-renderizar el detalle
                verDetalle(pedidoId);
            }
        }
        
        function iniciarCronometro(pedidoId, figuraIndex) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (pedido && pedido.figuras && pedido.figuras[figuraIndex]) {
                const figura = pedido.figuras[figuraIndex];
                
                if (!figura.fechaInicio) {
                    // Iniciar nuevo cron√≥metro
                    figura.fechaInicio = new Date().toISOString();
                    actualizarPedidoEnNube(pedido);
                    
                    // Iniciar actualizaci√≥n visual del cron√≥metro
                    const key = `${pedidoId}-${figuraIndex}`;
                    cronometrosActivos[key] = setInterval(() => {
                        actualizarCronometroVisual(pedidoId, figuraIndex);
                    }, 1000);
                    
                } else {
                    // Pausar cron√≥metro
                    const key = `${pedidoId}-${figuraIndex}`;
                    if (cronometrosActivos[key]) {
                        clearInterval(cronometrosActivos[key]);
                        delete cronometrosActivos[key];
                    }
                    
                    // Calcular tiempo parcial
                    figura.fechaFin = new Date().toISOString();
                    const tiempoMs = new Date(figura.fechaFin) - new Date(figura.fechaInicio);
                    figura.tiempoFabricacion = Math.round(tiempoMs / 60000);
                    actualizarPedidoEnNube(pedido);
                }
                
                verDetalle(pedidoId);
            }
        }
        
        function actualizarCronometroVisual(pedidoId, figuraIndex) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (pedido && pedido.figuras && pedido.figuras[figuraIndex]) {
                const figura = pedido.figuras[figuraIndex];
                if (figura.fechaInicio) {
                    const elemento = document.getElementById(`cronometro-${pedidoId}-${figuraIndex}`);
                    if (elemento) {
                        const tiempoMs = new Date() - new Date(figura.fechaInicio);
                        elemento.textContent = formatearTiempo(Math.floor(tiempoMs / 1000));
                    }
                }
            }
        }
        
        function formatearTiempo(segundos) {
            const horas = Math.floor(segundos / 3600);
            const minutos = Math.floor((segundos % 3600) / 60);
            const segs = segundos % 60;
            
            if (horas > 0) {
                return `${horas}h ${minutos}m ${segs}s`;
            } else if (minutos > 0) {
                return `${minutos}m ${segs}s`;
            } else {
                return `${segs}s`;
            }
        }
        
        function formatearTiempoMinutos(minutos) {
            if (!minutos || minutos === 0) return '-';
            
            const horas = Math.floor(minutos / 60);
            const mins = minutos % 60;
            
            if (horas > 0) {
                return `${horas}h ${mins}m`;
            } else {
                return `${mins}m`;
            }
        }
        
        function calcularEstadisticasTiempo(pedido) {
            if (!pedido.figuras || pedido.figuras.length === 0) return null;
            
            const figurasConTiempo = pedido.figuras.filter(f => f.tiempoFabricacion > 0);
            
            if (figurasConTiempo.length === 0) return null;
            
            const tiempos = figurasConTiempo.map(f => f.tiempoFabricacion);
            const total = tiempos.reduce((a, b) => a + b, 0);
            const promedio = Math.round(total / tiempos.length);
            const minimo = Math.min(...tiempos);
            const maximo = Math.max(...tiempos);
            
            // Estimar tiempo restante
            const figurasRestantes = pedido.figuras.filter(f => !f.fabricada).length;
            const tiempoEstimado = figurasRestantes * promedio;
            
            return {
                total,
                promedio,
                minimo,
                maximo,
                figurasConTiempo: figurasConTiempo.length,
                figurasRestantes,
                tiempoEstimado
            };
        }
        
        function calcularProgresoFiguras(figuras) {
            if (!figuras || figuras.length === 0) return 0;
            const fabricadas = figuras.filter(f => f.fabricada).length;
            return Math.round((fabricadas / figuras.length) * 100);
        }
        
        function contarFabricadas(figuras) {
            if (!figuras || figuras.length === 0) return 0;
            return figuras.filter(f => f.fabricada).length;
        }
        
        // Funciones para gestionar informaci√≥n de env√≠o
        function mostrarModalEnvio(pedidoId) {
            pedidoParaEnvio = pedidoId;
            document.getElementById('modalEnvio').classList.add('activo');
            document.getElementById('formEnvio').reset();
            
            // Establecer fecha de hoy por defecto
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaEnvio').value = hoy;
        }
        
        function editarInformacionEnvio(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (pedido && pedido.infoEnvio) {
                pedidoParaEnvio = pedidoId;
                document.getElementById('modalEnvio').classList.add('activo');
                
                // Cargar datos existentes
                document.getElementById('numeroSeguimiento').value = pedido.infoEnvio.numeroSeguimiento;
                document.getElementById('fechaEnvio').value = pedido.infoEnvio.fechaEnvio.split('T')[0];
                document.getElementById('valorEnvio').value = pedido.infoEnvio.valorEnvio || 0;
                document.getElementById('empresaEnvio').value = pedido.infoEnvio.empresaEnvio;
            }
        }
        
        function cerrarModalEnvio() {
            document.getElementById('modalEnvio').classList.remove('activo');
            pedidoParaEnvio = null;
        }
        
        function guardarInformacionEnvio(event) {
            event.preventDefault();
            
            if (!pedidoParaEnvio) return;
            
            const pedido = pedidos.find(p => p.id === pedidoParaEnvio);
            if (!pedido) return;
            
            // Guardar informaci√≥n de env√≠o
            pedido.infoEnvio = {
                numeroSeguimiento: document.getElementById('numeroSeguimiento').value,
                fechaEnvio: document.getElementById('fechaEnvio').value,
                valorEnvio: parseFloat(document.getElementById('valorEnvio').value) || 0,
                empresaEnvio: document.getElementById('empresaEnvio').value
            };
            
            // Actualizar en la nube
            actualizarPedidoEnNube(pedido).then(success => {
                if (success) {
                    alert('‚úÖ Informaci√≥n de env√≠o guardada exitosamente');
                } else {
                    alert('‚ö†Ô∏è Informaci√≥n guardada localmente. Verifica tu conexi√≥n.');
                }
                cerrarModalEnvio();
                verDetalle(pedidoParaEnvio);
            });
        }
        
        // Funciones para gestionar hitos de producci√≥n
        function toggleHito(pedidoId, figuraIndex, hito) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (pedido && pedido.figuras && pedido.figuras[figuraIndex]) {
                const figura = pedido.figuras[figuraIndex];
                
                // Inicializar hitos si no existen
                if (!figura.hitos) {
                    figura.hitos = {
                        laminado: false,
                        fabricado: false,
                        curado: false,
                        imprimado: false
                    };
                }
                
                // Toggle el hito
                figura.hitos[hito] = !figura.hitos[hito];
                
                // Actualizar en la nube
                actualizarPedidoEnNube(pedido);
                
                // Re-renderizar el detalle
                verDetalle(pedidoId);
            }
        }
        
        function calcularProgresoHitos(hitos) {
            if (!hitos) return 0;
            const total = 4; // Total de hitos
            const completados = Object.values(hitos).filter(v => v).length;
            return Math.round((completados / total) * 100);
        }
        
        function contarHitosCompletados(hitos) {
            if (!hitos) return 0;
            return Object.values(hitos).filter(v => v).length;
        }
        
        function imprimirPedidoDirecto(id) {
            const pedido = pedidos.find(p => p.id === id);
            if (!pedido) return;
            generarPaginaImpresion(pedido);
        }
        
        function imprimirEtiquetaDirecta(id) {
            const pedido = pedidos.find(p => p.id === id);
            if (!pedido) return;
            generarEtiquetaEnvio(pedido);
        }
        
        function imprimirEtiquetaEnvio() {
            if (!pedidoActual) return;
            generarEtiquetaEnvio(pedidoActual);
        }
        
        function generarEtiquetaEnvio(pedido) {
            const paginaEtiqueta = document.getElementById('paginaImpresion');
            
            paginaEtiqueta.innerHTML = `
                <div style="width: 10cm; height: 15cm; padding: 1cm; font-family: Arial, sans-serif; page-break-after: always;">
                    <!-- Header -->
                    <div style="text-align: center; border-bottom: 3px solid #2c3e50; padding-bottom: 15px; margin-bottom: 20px;">
                        <h1 style="margin: 0; font-size: 24px; color: #2c3e50;">üßô‚Äç‚ôÇÔ∏è Emporio de Hagrid</h1>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #7f8c8d;">Figuras 3D en Resina</p>
                    </div>
                    
                    <!-- Destinatario -->
                    <div style="border: 2px solid #2c3e50; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="background: #2c3e50; color: white; padding: 8px; margin: -15px -15px 15px -15px; border-radius: 8px 8px 0 0;">
                            <strong style="font-size: 14px;">üìç DESTINATARIO</strong>
                        </div>
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #2c3e50;">
                            ${pedido.nombre} ${pedido.apellido || ''}
                        </div>
                        <div style="font-size: 14px; line-height: 1.6; color: #34495e;">
                            <div style="margin-bottom: 5px;">üì± ${pedido.celular || 'N/A'}</div>
                            ${pedido.email ? `<div style="margin-bottom: 5px;">üìß ${pedido.email}</div>` : ''}
                            <div style="margin-bottom: 5px; font-weight: bold; font-size: 15px;">üì´ ${pedido.direccion || 'N/A'}</div>
                            <div style="font-size: 16px; font-weight: bold; background: #ecf0f1; padding: 8px; border-radius: 5px; margin-top: 8px;">
                                ${pedido.comuna || 'N/A'}, ${pedido.ubicacion || 'Chile'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informaci√≥n del Pedido -->
                    <div style="background: #ecf0f1; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 11px; color: #7f8c8d;">PEDIDO</div>
                                <div style="font-size: 16px; font-weight: bold; color: #2c3e50;">#${pedido.id}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 11px; color: #7f8c8d;">FECHA</div>
                                <div style="font-size: 14px; font-weight: bold; color: #2c3e50;">${new Date(pedido.fechaPedido).toLocaleDateString('es-CL')}</div>
                            </div>
                        </div>
                    </div>
                    
                    ${pedido.infoEnvio ? `
                    <!-- Informaci√≥n de Tracking -->
                    <div style="border: 2px dashed #3498db; padding: 12px; border-radius: 8px; margin-bottom: 15px; background: #ebf5fb;">
                        <div style="font-size: 11px; color: #2980b9; font-weight: bold; margin-bottom: 5px;">TRACKING</div>
                        <div style="font-size: 18px; font-weight: bold; color: #2c3e50; font-family: monospace; letter-spacing: 1px;">
                            ${pedido.infoEnvio.numeroSeguimiento}
                        </div>
                        <div style="font-size: 12px; color: #34495e; margin-top: 5px;">
                            ${pedido.infoEnvio.empresaEnvio}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Contenido -->
                    <div style="border-top: 2px solid #bdc3c7; padding-top: 12px;">
                        <div style="font-size: 11px; color: #7f8c8d; margin-bottom: 5px;">CONTENIDO</div>
                        <div style="font-size: 13px; color: #2c3e50;">
                            ${pedido.figuras && pedido.figuras.length > 0 ? 
                                `${pedido.figuras.length} figura${pedido.figuras.length > 1 ? 's' : ''} en resina` 
                                : 'Figuras 3D en resina'}
                        </div>
                        ${pedido.estadoPago === 'Por Pagar' ? `
                            <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 8px; border-radius: 5px; margin-top: 10px; text-align: center;">
                                <strong style="color: #856404;">‚ö†Ô∏è PAGO PENDIENTE</strong>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Footer -->
                    <div style="position: absolute; bottom: 1cm; left: 1cm; right: 1cm; text-align: center; font-size: 10px; color: #95a5a6; border-top: 1px solid #bdc3c7; padding-top: 10px;">
                        <div>Man√©jese con cuidado ‚Ä¢ Producto fr√°gil</div>
                        ${pedido.instagram ? `<div style="margin-top: 3px;">üì∑ ${pedido.instagram}</div>` : ''}
                    </div>
                </div>
            `;
            
            // Imprimir
            window.print();
        }
        
        function imprimirPedido() {
            if (!pedidoActual) return;
            generarPaginaImpresion(pedidoActual);
        }
        
        function generarPaginaImpresion(pedido) {
            const estadoTexto = {
                recibido: 'Pedido Recibido',
                fabricacion: 'En Fabricaci√≥n',
                revision: 'En Revisi√≥n',
                listo: 'Listo para Entrega',
                entregado: 'Entregado'
            }[pedido.estado];
            
            const nombreCliente = pedido.nombreCompleto || pedido.nombreCliente || `${pedido.nombre || ''} ${pedido.apellido || ''}`.trim();
            
            let imagenesHTML = '';
            if (pedido.imagenes && pedido.imagenes.length > 0) {
                imagenesHTML = `
                    <div class="impresion-seccion">
                        <h3>üì∑ Im√°genes de la Figura</h3>
                        <div class="impresion-imagenes">
                            ${pedido.imagenes.map((img, index) => `
                                <div class="impresion-imagen">
                                    <img src="${img}" alt="Figura ${index + 1}">
                                    <p>Imagen ${index + 1}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            let timelineHTML = pedido.timeline.map(item => `
                <div class="impresion-timeline-item">
                    <div class="impresion-timeline-check ${item.completado ? 'completado' : 'pendiente'}">
                        ${item.completado ? '‚úì' : '‚óã'}
                    </div>
                    <div style="flex: 1;">
                        <strong>${item.etapa}</strong>
                        ${item.completado && item.fecha ? `
                            <div style="font-size: 13px; color: #6b7280; margin-top: 3px;">
                                ${new Date(item.fecha).toLocaleDateString()} - ${new Date(item.fecha).toLocaleTimeString()}
                            </div>
                        ` : '<div style="font-size: 13px; color: #9ca3af;">Pendiente</div>'}
                    </div>
                </div>
            `).join('');
            
            const paginaImpresion = document.getElementById('paginaImpresion');
            paginaImpresion.innerHTML = `
                <div class="impresion-header">
                    <h1>üßô‚Äç‚ôÇÔ∏è Emporio de Hagrid</h1>
                    <p style="font-size: 18px; color: #6b7280;">Orden de Pedido</p>
                </div>
                
                <div style="text-align: right; margin-bottom: 20px; color: #6b7280;">
                    <strong>Pedido #${pedido.id}</strong><br>
                    Fecha: ${new Date(pedido.fechaPedido).toLocaleDateString()}<br>
                    Estado: <strong style="color: #7c3aed;">${estadoTexto}</strong><br>
                    <span style="color: ${pedido.estadoPago === 'Pagado' ? '#10b981' : '#f59e0b'}; font-weight: bold;">
                        ${pedido.estadoPago || 'Estado de pago no especificado'}
                    </span>
                </div>
                
                <div class="impresion-seccion">
                    <h3>üë§ Informaci√≥n del Cliente</h3>
                    <table class="impresion-tabla">
                        ${pedido.nombre ? `
                            <tr>
                                <td>Nombre:</td>
                                <td>${pedido.nombre}</td>
                            </tr>
                        ` : ''}
                        ${pedido.apellido ? `
                            <tr>
                                <td>Apellido:</td>
                                <td>${pedido.apellido}</td>
                            </tr>
                        ` : ''}
                        ${!pedido.nombre && !pedido.apellido ? `
                            <tr>
                                <td>Nombre:</td>
                                <td>${nombreCliente}</td>
                            </tr>
                        ` : ''}
                        <tr>
                            <td>Celular:</td>
                            <td>${pedido.celular || pedido.telefono || 'No especificado'}</td>
                        </tr>
                        ${pedido.instagram ? `
                            <tr>
                                <td>Instagram:</td>
                                <td>${pedido.instagram}</td>
                            </tr>
                        ` : ''}
                        ${pedido.email ? `
                            <tr>
                                <td>Email:</td>
                                <td>${pedido.email}</td>
                            </tr>
                        ` : ''}
                        <tr>
                            <td>Direcci√≥n de Entrega:</td>
                            <td>${pedido.direccion || 'No especificada'}</td>
                        </tr>
                        ${pedido.comuna ? `
                            <tr>
                                <td>Comuna:</td>
                                <td>${pedido.comuna}</td>
                            </tr>
                        ` : ''}
                        ${pedido.ubicacion ? `
                            <tr>
                                <td>Ubicaci√≥n:</td>
                                <td><strong>${pedido.ubicacion}</strong></td>
                            </tr>
                        ` : ''}
                        ${pedido.estadoPago ? `
                            <tr>
                                <td>Estado de Pago:</td>
                                <td><strong style="color: ${pedido.estadoPago === 'Pagado' ? '#10b981' : '#f59e0b'};">${pedido.estadoPago}</strong></td>
                            </tr>
                        ` : ''}
                    </table>
                </div>
                
                ${pedido.infoEnvio ? `
                    <div class="impresion-seccion">
                        <h3>üì¶ Informaci√≥n de Env√≠o</h3>
                        <table class="impresion-tabla">
                            <tr>
                                <td>N√∫mero de Seguimiento:</td>
                                <td><strong>${pedido.infoEnvio.numeroSeguimiento}</strong></td>
                            </tr>
                            <tr>
                                <td>Fecha de Env√≠o:</td>
                                <td>${new Date(pedido.infoEnvio.fechaEnvio).toLocaleDateString('es-CL')}</td>
                            </tr>
                            <tr>
                                <td>Empresa de Env√≠o:</td>
                                <td>${pedido.infoEnvio.empresaEnvio}</td>
                            </tr>
                            ${pedido.infoEnvio.valorEnvio > 0 ? `
                                <tr>
                                    <td>Valor del Env√≠o:</td>
                                    <td><strong style="color: #10b981;">${pedido.infoEnvio.valorEnvio.toLocaleString('es-CL')}</strong></td>
                                </tr>
                            ` : ''}
                        </table>
                    </div>
                ` : ''}
                
                <div class="impresion-seccion">
                    <h3>üé® Cotizaci√≥n de Figuras</h3>
                    ${pedido.figuras && pedido.figuras.length > 0 ? `
                        <div style="margin-bottom: 15px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                            <strong>Progreso de Fabricaci√≥n:</strong> ${contarFabricadas(pedido.figuras)} de ${pedido.figuras.length} figuras completadas (${calcularProgresoFiguras(pedido.figuras)}%)
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; width: 40px;">‚úì</th>
                                    <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: left;">Figura</th>
                                    <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: left;">Tama√±o</th>
                                    <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: left;">Material</th>
                                    <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">Cant.</th>
                                    <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: right;">Valor Unit.</th>
                                    <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: right;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pedido.figuras.map(fig => `
                                    <tr style="${fig.fabricada ? 'background: #f0fdf4;' : ''}">
                                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">
                                            <input type="checkbox" ${fig.fabricada ? 'checked' : ''} style="width: 18px; height: 18px;">
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #e5e7eb; ${fig.fabricada ? 'text-decoration: line-through; color: #10b981;' : ''}">${fig.nombre}</td>
                                        <td style="padding: 10px; border: 1px solid #e5e7eb;">${fig.tamanoFinal || fig.tamano}</td>
                                        <td style="padding: 10px; border: 1px solid #e5e7eb;">${fig.materialFinal || fig.material}</td>
                                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${fig.cantidad}</td>
                                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: right;">${fig.valorUnitario.toLocaleString('es-CL')}</td>
                                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: right;"><strong>${fig.valorTotal.toLocaleString('es-CL')}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; background: #f9fafb; padding: 20px; border-radius: 8px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <td style="padding: 8px 0; text-align: right; width: 70%;"><strong>Subtotal:</strong></td>
                                    <td style="padding: 8px 0; text-align: right; width: 30%; font-size: 18px;"><strong>$${pedido.subtotal.toLocaleString('es-CL')}</strong></td>
                                </tr>
                                ${pedido.descuentoPorcentaje > 0 ? `
                                    <tr>
                                        <td style="padding: 8px 0; text-align: right; color: #f59e0b;"><strong>Descuento (${pedido.descuentoPorcentaje}%):</strong></td>
                                        <td style="padding: 8px 0; text-align: right; color: #f59e0b; font-size: 18px;"><strong>-$${pedido.descuento.toLocaleString('es-CL')}</strong></td>
                                    </tr>
                                ` : ''}
                                <tr style="border-top: 3px solid #9333ea;">
                                    <td style="padding: 15px 0; text-align: right; color: #7c3aed;"><strong style="font-size: 22px;">TOTAL:</strong></td>
                                    <td style="padding: 15px 0; text-align: right; color: #7c3aed;"><strong style="font-size: 22px;">$${pedido.totalFinal.toLocaleString('es-CL')}</strong></td>
                                </tr>
                            </table>
                        </div>
                    ` : `
                        <table class="impresion-tabla">
                            <tr>
                                <td>Nombre de la Figura:</td>
                                <td><strong style="font-size: 18px;">${pedido.nombreFigura || 'N/A'}</strong></td>
                            </tr>
                            ${pedido.descripcion ? `
                                <tr>
                                    <td>Descripci√≥n:</td>
                                    <td>${pedido.descripcion}</td>
                                </tr>
                            ` : ''}
                            ${pedido.precio ? `
                                <tr>
                                    <td>Precio:</td>
                                    <td><strong style="font-size: 18px; color: #10b981;">$${pedido.precio}</strong></td>
                                </tr>
                            ` : ''}
                        </table>
                    `}
                    ${pedido.observaciones ? `
                        <div style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #9333ea;">
                            <strong>Observaciones:</strong>
                            <p style="margin: 10px 0 0 0;">${pedido.observaciones}</p>
                        </div>
                    ` : ''}
                </div>
                
                ${imagenesHTML}
                
                <div class="impresion-seccion">
                    <h3>üìã L√≠nea de Tiempo del Pedido</h3>
                    <div class="impresion-timeline">
                        ${timelineHTML}
                    </div>
                </div>
                
                <div class="impresion-pie">
                    <p><strong>Emporio de Hagrid</strong> - Figuras 3D en Resina</p>
                    <p>Documento generado el ${new Date().toLocaleDateString()} a las ${new Date().toLocaleTimeString()}</p>
                </div>
            `;
            
            // Imprimir
            window.print();
        }
    </script>
</body>
</html>